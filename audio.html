<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recovery Misfits — Audio</title>
  <meta name="theme-color" content="#ffffff" />
  <link rel="icon" href="./icon-192.png">

  <style>
    :root { --border: rgba(0,0,0,.12); --muted: rgba(0,0,0,.65); }
    body{
      font-family:Roboto,Arial,sans-serif;
      margin:0;
      background:#fff;
      color:#111;
      line-height:1.35;
    }
    header{
      position:sticky;
      top:0;
      z-index:9000;
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:12px;
      text-align:center;
    }
    .brand{font-weight:900;font-size:16px;}
    .sub{font-size:13px;color:var(--muted);margin-top:2px}
    main{max-width:860px;margin:0 auto;padding:14px;}

    .card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      margin:12px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
      background:#fff;
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:#fff;
      color:#111;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: rgba(0,0,0,.25);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .btn.mini{
      padding:8px 10px;
      font-size:13px;
      font-weight:900;
    }

    .hint{font-size:13px;color:var(--muted);margin-top:8px}

    /* Library rows */
    .library{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .rowCard{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:12px;
      background:#fff;
    }
    .titleWrap{min-width:0; flex:1;}
    .title{font-weight:900; font-size:14px; margin:0;}
    .subtitle{font-size:12px; color:var(--muted); margin-top:3px;}

    /* Player areas */
    .playerAreaTitle{
      font-weight:900;
      margin-bottom:8px;
    }
    .now{font-size:13px;color:var(--muted)}
    audio{width:100%}

    .playerBox{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* Chapters list (Gorilla) */
    .list{margin-top:12px}
    .row{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 0; border-top:1px solid rgba(0,0,0,.08);
    }
    .row:first-child{border-top:none}
    .chapterTitle{
      font-weight:800; font-size:14px; margin:0;
    }
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .current{
      outline:2px solid rgba(0,0,0,.15);
      border-radius:12px;
      padding:10px;
      margin:8px 0;
      background: rgba(0,0,0,.02);
    }
    .resumeLine{font-size:13px;color:var(--muted);margin-top:6px; display:none;}

    /* YouTube embed */
    .videoWrap{
      position:relative;
      padding-top:56.25%;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border);
      background: rgba(0,0,0,.02);
    }
    .videoWrap iframe{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .toolbarLeft{
      min-width:0;
      flex:1;
    }

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background:#111; color:#fff; padding:10px 12px; border-radius:12px;
      font-size:13px; opacity:0; pointer-events:none;
      transition:opacity .18s ease;
      max-width:92vw;
    }
    .toast.show{opacity:0.92}

    @media (max-width:520px){
      .actions{justify-content:flex-start;}
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">Recovery Misfits — Audio</div>
    <div class="sub" id="subTitle">Audio Library</div>
  </header>

  <main>

    <!-- Audio Library (everything equal footing) -->
    <section class="card">
      <div style="font-weight:900;margin-bottom:8px;">Audio Library</div>
      <div class="hint">Play means play. Tap one and it loads right here.</div>

      <div class="library" style="margin-top:12px;" id="library"></div>
    </section>

    <!-- Shared Player Area -->
    <section class="card" id="playerArea" style="display:none;">
      <div class="toolbar">
        <div class="toolbarLeft">
          <div class="playerAreaTitle" id="playerAreaTitle">Now Playing</div>
          <div class="now" id="playerAreaSub">Ready</div>
        </div>
        <div class="actions">
          <button class="btn mini" id="stopBtn" type="button">Stop</button>
          <button class="btn mini" id="unloadBtn" type="button">Unload</button>
        </div>
      </div>

      <!-- Gorilla player -->
      <div id="gorillaArea" style="display:none; margin-top:12px;">
        <div class="toprow" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="playAllBtn" class="btn primary" type="button">▶ Play All</button>
          <button id="clearResumeBtn" class="btn" type="button">Reset Resume</button>
        </div>
        <div id="resumeLine" class="resumeLine"></div>

        <div class="playerBox" style="margin-top:12px;">
          <div class="now" id="nowPlaying">Not playing</div>
          <audio id="player" controls preload="metadata"></audio>
        </div>

        <div style="font-weight:900;margin-top:14px;">Chapters</div>
        <div id="chapterList" class="list"></div>
      </div>

      <!-- YouTube player -->
      <div id="ytArea" style="display:none; margin-top:12px;">
        <div class="videoWrap" id="ytBox">
          <iframe
            id="ytFrame"
            title="YouTube"
            allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            referrerpolicy="origin-when-cross-origin"
          ></iframe>
        </div>
        <div class="hint" style="margin-top:10px;">
          If YouTube glitches: hit <b>Unload</b>, then press Play again.
        </div>
      </div>
    </section>

    <div id="toast" class="toast"></div>
  </main>

  <script>
    // ==========================
    // Toast
    // ==========================
    const toastEl = document.getElementById("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1400);
    }

    // ==========================
    // Library items (equal footing)
    // ==========================
    // Types:
    // - "gorilla" => Bunny MP3 + chapters
    // - "yt_playlist" => YouTube playlist embed
    // - "yt_video" => YouTube single video embed (with start seconds)
    const LIBRARY = [
      { type:"gorilla", key:"gorilla", title:"Alcoholism: The 500 Pound Gorilla", sub:"Audiobook (Bunny stream)" },

      { type:"yt_playlist", key:"joe",    title:"Joe & Charlie",        sub:"Big Book Study", id:"PLxb8I9B3VlNvAKFFZugCC8a7Pq6tkpF7E" },
      { type:"yt_playlist", key:"martin", title:"Father Martin",        sub:"Chalk Talks",    id:"PLvwn9cjv4shDAovzrlf_5k0pW9hF_P8Lf" },
      { type:"yt_playlist", key:"chuck",  title:"Chuck C",              sub:"A New Pair of Glasses", id:"PLxb8I9B3VlNvBfT34yoa_MU2zay5WTsiA" },
      { type:"yt_playlist", key:"allen",  title:"Allen McGinnis",        sub:"Building a House of Sobriety", id:"PLxb8I9B3VlNv7NFjbYLO809xJBBhf7CuE" },

      // Single video (your last link): vYvZTH746yg&t=10s
      { type:"yt_video", key:"bonus", title:"Bonus Talk - Dr. Labor", sub:"Single video", id:"vYvZTH746yg", start:10 },
    ];

    const libraryEl = document.getElementById("library");

    // ==========================
    // Shared Player Area elements
    // ==========================
    const playerArea = document.getElementById("playerArea");
    const playerAreaTitle = document.getElementById("playerAreaTitle");
    const playerAreaSub = document.getElementById("playerAreaSub");
    const stopBtn = document.getElementById("stopBtn");
    const unloadBtn = document.getElementById("unloadBtn");

    const gorillaArea = document.getElementById("gorillaArea");
    const ytArea = document.getElementById("ytArea");
    const ytFrame = document.getElementById("ytFrame");

    // Gorilla audio elements
    const player = document.getElementById("player");
    const nowPlaying = document.getElementById("nowPlaying");
    const chapterList = document.getElementById("chapterList");
    const playAllBtn = document.getElementById("playAllBtn");
    const clearResumeBtn = document.getElementById("clearResumeBtn");
    const resumeLine = document.getElementById("resumeLine");

    // ==========================
    // Utility: show player area + scroll
    // ==========================
    function showPlayerArea(){
      playerArea.style.display = "block";
      playerArea.scrollIntoView({ behavior:"smooth", block:"start" });
    }

    function stopEverything(){
      // Stop Gorilla audio
      try{ player.pause(); }catch(e){}
      // Stop YouTube
      ytFrame.src = "";
      toast("Stopped");
    }

    function unloadEverything(){
      // Stop and hide player types
      stopEverything();
      gorillaArea.style.display = "none";
      ytArea.style.display = "none";
      playerAreaSub.textContent = "Ready";
      toast("Unloaded");
    }

    stopBtn.addEventListener("click", stopEverything);
    unloadBtn.addEventListener("click", unloadEverything);

    // ==========================
    // YouTube helpers
    // ==========================
    function playYouTubePlaylist(title, sub, listId){
      unloadEverything(); // clears old YT + audio and hides areas
      playerAreaTitle.textContent = title;
      playerAreaSub.textContent = sub;
      ytArea.style.display = "block";

      // Load playlist immediately (Play means play)
      ytFrame.src = `https://www.youtube.com/embed/videoseries?list=${encodeURIComponent(listId)}`;

      showPlayerArea();
      toast("Playing: " + title);
    }

    function playYouTubeVideo(title, sub, videoId, startSeconds=0){
      unloadEverything();
      playerAreaTitle.textContent = title;
      playerAreaSub.textContent = sub;
      ytArea.style.display = "block";

      const start = Math.max(0, Number(startSeconds||0));
      const qs = start ? `?start=${start}` : "";
      ytFrame.src = `https://www.youtube.com/embed/${encodeURIComponent(videoId)}${qs}`;

      showPlayerArea();
      toast("Playing: " + title);
    }

    // ==========================
    // Gorilla audiobook (your original code, integrated)
    // ==========================

    // === Source of truth: Bunny URLs (use filenames exactly) ===
    const TRACKS = [
      { n: 1,  title: "1. So Here You Are", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/1.%20So%20Here%20You%20Are.mp3" },
      { n: 2,  title: "2. The Rat Trap", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/2.%20The%20Rat%20Trap.mp3" },
      { n: 3,  title: "3. My Off Switch is Broke", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/3.%20My%20Off%20Switch%20is%20Broke.mp3" },
      { n: 4,  title: "4. The Screw It Button", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/4.%20The%20Screw%20It%20Button.mp3" },
      { n: 5,  title: "5. The Disease Concept", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/5.%20The%20Disease%20Concept.mp3" },
      // Note: URL includes trailing space before .mp3 in the actual filename. Keep it EXACT so it works.
      { n: 6,  title: "6. The 500 Pound Gorilla", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/6.%20The%20500%20Pound%20Gorilla%20.mp3" },
      { n: 7,  title: "7. The Edge", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/7.%20The%20Edge.mp3" },
      { n: 8,  title: "8. The Ultimate Sacrifice", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/8.%20The%20Ultimate%20Sacrifice.mp3" },
      { n: 9,  title: "9. Fork in the Road", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/9.%20Fork%20in%20the%20Road.mp3" },
      { n: 10, title: "10. No More Deals with the Gorilla", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/10.%20No%20More%20Deals%20with%20the%20Gorilla.mp3" },
      { n: 11, title: "11. The Excuse Machine", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/11.%20The%20Excuse%20Machine.mp3" },
      { n: 12, title: "12. Debate Club is Over", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/12.%20Debate%20Club%20is%20Over.mp3" },
      { n: 13, title: "13. Connection Is the Opposite of Addiction", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/13.%20Connection%20Is%20the%20Opposite%20of%20Addiction.mp3" },
      { n: 14, title: "14. Change or Die", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/14.%20Change%20or%20Die.mp3" },
      { n: 15, title: "15. Spirituality", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/15.%20Spirituality.mp3" },
      { n: 16, title: "16. Credits", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/16.%20Credits.mp3" },
      { n: 17, title: "17. With Gratitude", url: "https://recovery-misfits-audio.b-cdn.net/gorilla-audiobook/17.%20With%20Gratitude.mp3" },
    ];

    // === State + persistence (resume where they left off) ===
    const LS_KEY = "rm_audio_resume_v1"; // { idx, t, mode }

    let currentIdx = 0;
    let playMode = "single"; // "all" or "single"
    let isSeekingResume = false;

    function loadResume(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(typeof obj?.idx !== "number" || typeof obj?.t !== "number") return null;
        if(obj.idx < 0 || obj.idx >= TRACKS.length) return null;
        if(obj.t < 0) obj.t = 0;
        return obj;
      }catch(e){
        return null;
      }
    }

    function saveResume(){
      const t = player.currentTime || 0;
      const obj = { idx: currentIdx, t: Math.floor(t), mode: playMode };
      try{ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }catch(e){}
      renderResumeLine();
    }

    function clearResume(){
      try{ localStorage.removeItem(LS_KEY); }catch(e){}
      renderResumeLine();
      toast("Resume cleared");
    }

    function fmtTime(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function renderResumeLine(){
      const r = loadResume();
      if(!r){
        resumeLine.style.display = "none";
        resumeLine.textContent = "";
        return;
      }
      const tr = TRACKS[r.idx];
      resumeLine.style.display = "block";
      resumeLine.textContent = `Resuming: ${tr.title} (${fmtTime(r.t)})`;
    }

    function setNowPlaying(idx){
      const tr = TRACKS[idx];
      nowPlaying.textContent = `Now Playing: ${tr.title}`;
      document.querySelectorAll("[data-track-row]").forEach(el=>{
        el.classList.toggle("current", Number(el.dataset.idx) === idx);
      });
    }

    function setTrack(idx, {autoplay=true, resumeTime=0} = {}){
      currentIdx = idx;
      const tr = TRACKS[idx];
      player.src = tr.url;
      setNowPlaying(idx);

      isSeekingResume = resumeTime > 0;

      const onMeta = () => {
        player.removeEventListener("loadedmetadata", onMeta);
        if(isSeekingResume){
          try{
            player.currentTime = Math.min(resumeTime, (player.duration || resumeTime));
          }catch(e){}
          isSeekingResume = false;
        }
        if(autoplay){
          player.play().catch(()=>{});
        }
      };
      player.addEventListener("loadedmetadata", onMeta);

      saveResume();
    }

    function playAll(){
      playMode = "all";
      const r = loadResume();
      if(r && typeof r.idx === "number"){
        setTrack(r.idx, {autoplay:true, resumeTime:r.t || 0});
        toast("Play All (resuming)");
      } else {
        setTrack(0, {autoplay:true, resumeTime:0});
        toast("Play All");
      }
      saveResume();
    }

    function playSingle(idx){
      playMode = "single";
      setTrack(idx, {autoplay:true, resumeTime:0});
      saveResume();
    }

    function downloadTrack(idx){
      const tr = TRACKS[idx];
      const a = document.createElement("a");
      a.href = tr.url;
      a.download = "";
      document.body.appendChild(a);
      a.click();
      a.remove();
      toast("Downloading…");
    }

    async function shareTrack(idx){
      const tr = TRACKS[idx];
      const shareData = {
        title: "Alcoholism: The 500 Pound Gorilla (Audio)",
        text: tr.title + " — Pass it on if it helps.",
        url: tr.url
      };

      if(navigator.share){
        try{
          await navigator.share(shareData);
          toast("Shared");
          return;
        }catch(e){}
      }

      try{
        await navigator.clipboard.writeText(tr.url);
        toast("Link copied");
      }catch(e){
        window.prompt("Copy this link:", tr.url);
      }
    }

    function buildChapters(){
      chapterList.innerHTML = "";
      TRACKS.forEach((tr, idx)=>{
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.trackRow = "1";
        row.dataset.idx = String(idx);

        const left = document.createElement("div");
        left.className = "titleWrap";
        const title = document.createElement("div");
        title.className = "chapterTitle";
        title.textContent = tr.title;
        left.appendChild(title);

        const actions = document.createElement("div");
        actions.className = "actions";

        const playBtn = document.createElement("button");
        playBtn.className = "btn mini";
        playBtn.type = "button";
        playBtn.textContent = "Play";
        playBtn.addEventListener("click", ()=>playSingle(idx));

        const dlBtn = document.createElement("button");
        dlBtn.className = "btn mini";
        dlBtn.type = "button";
        dlBtn.textContent = "Download";
        dlBtn.addEventListener("click", ()=>downloadTrack(idx));

        const shareBtn = document.createElement("button");
        shareBtn.className = "btn mini";
        shareBtn.type = "button";
        shareBtn.textContent = "Share";
        shareBtn.addEventListener("click", ()=>shareTrack(idx));

        actions.appendChild(playBtn);
        actions.appendChild(dlBtn);
        actions.appendChild(shareBtn);

        row.appendChild(left);
        row.appendChild(actions);
        chapterList.appendChild(row);
      });
    }

    // Auto-advance when in Play All mode
    player.addEventListener("ended", ()=>{
      if(playMode !== "all") return;
      const next = currentIdx + 1;
      if(next >= TRACKS.length){
        toast("Finished");
        return;
      }
      setTrack(next, {autoplay:true, resumeTime:0});
      saveResume();
    });

    // Save progress periodically + on pause
    let lastSavedAt = 0;
    player.addEventListener("timeupdate", ()=>{
      const t = player.currentTime || 0;
      if(t - lastSavedAt >= 10){
        lastSavedAt = t;
        saveResume();
      }
    });
    player.addEventListener("pause", saveResume);

    // Save on exit
    window.addEventListener("beforeunload", saveResume);
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState === "hidden") saveResume();
    });

    playAllBtn.addEventListener("click", playAll);
    clearResumeBtn.addEventListener("click", clearResume);

    function showGorilla(){
      // Stop YouTube and show Gorilla UI
      ytFrame.src = "";
      ytArea.style.display = "none";

      gorillaArea.style.display = "block";
      playerAreaTitle.textContent = "Alcoholism: The 500 Pound Gorilla";
      playerAreaSub.textContent = "Audiobook (Bunny stream)";

      showPlayerArea();
    }

    // ==========================
    // Build Library UI
    // ==========================
    function buildLibrary(){
      libraryEl.innerHTML = "";
      LIBRARY.forEach((item)=>{
        const row = document.createElement("div");
        row.className = "rowCard";

        const left = document.createElement("div");
        left.className = "titleWrap";

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = item.title;

        const s = document.createElement("div");
        s.className = "subtitle";
        s.textContent = item.sub;

        left.appendChild(t);
        left.appendChild(s);

        const playBtn = document.createElement("button");
        playBtn.className = "btn primary";
        playBtn.type = "button";
        playBtn.textContent = "▶ Play";

        playBtn.addEventListener("click", ()=>{
          if(item.type === "gorilla"){
            unloadEverything();
            showGorilla();
            // Don’t force autoplay on open; user can hit Play All or a chapter.
            toast("Opened Gorilla");
            return;
          }

          if(item.type === "yt_playlist"){
            playYouTubePlaylist(item.title, item.sub, item.id);
            return;
          }

          if(item.type === "yt_video"){
            playYouTubeVideo(item.title, item.sub, item.id, item.start || 0);
            return;
          }
        });

        row.appendChild(left);
        row.appendChild(playBtn);
        libraryEl.appendChild(row);
      });
    }

    // Init
    buildLibrary();
    buildChapters();
    renderResumeLine();

    // Prep Gorilla state (no autoplay)
    const r0 = loadResume();
    if(r0){
      currentIdx = r0.idx;
      playMode = r0.mode || "single";
      setTrack(r0.idx, {autoplay:false, resumeTime:0});
      try{ player.currentTime = 0; }catch(e){}
      nowPlaying.textContent = "Ready: " + TRACKS[r0.idx].title;
      setNowPlaying(r0.idx);
    } else {
      setTrack(0, {autoplay:false, resumeTime:0});
      try{ player.currentTime = 0; }catch(e){}
      nowPlaying.textContent = "Ready: " + TRACKS[0].title;
      setNowPlaying(0);
    }
  </script>
</body>
</html>
