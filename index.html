<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recovery Misfits</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff" />
  <link rel="icon" href="./icon-192.png">

  <style>
    body{
      font-family: Roboto, Arial, sans-serif;
      margin: 0;
      background: #fff;
      color: #111;
    }
    header{
      position: sticky;
      top: 0;
      z-index: 9999;
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,.12);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .brand{
      font-weight: 900;
      font-size: 16px;
      line-height: 1.2;
    }
    .actions{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    button{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.18);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
      color:#111;
      white-space: nowrap;
    }
    .frameWrap{
      height: calc(100vh - 52px);
      width: 100%;
    }
    iframe{
      width: 100%;
      height: 100%;
      border: 0;
      display:block;
      background:#fff;
    }

    /* Tools panel (bottom sheet) */
    .sheetBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      z-index: 10000;
    }
    .sheet{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #fff;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 -10px 40px rgba(0,0,0,.18);
      padding: 14px;
      max-height: 75vh;
      overflow: auto;
      transform: translateY(110%);
      transition: transform .22s ease;
      z-index: 10001;
    }
    .sheet.open{ transform: translateY(0); }
    .sheetHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
    }
    .sheetTitle{
      font-weight: 1000;
      font-size: 16px;
    }
    .muted{ opacity: .75; }
    .card{
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    input{
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.18);
      font-weight: 700;
      margin-top: 8px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .big{
      font-size: 22px;
      font-weight: 1000;
      margin-top: 8px;
    }
  </style>
</head>

<body>

<header>
  <div class="brand">Recovery Misfits</div>
  <div class="actions">
    <button id="toolsBtn" type="button">Tools</button>
    <button id="openBlogBtn" type="button">Open in Browser</button>
  </div>
</header>

<div class="frameWrap">
  <iframe id="blogFrame" title="Recovery Misfits Blog" src="https://recoverymisfits.blogspot.com/"></iframe>
</div>

<!-- Tools Bottom Sheet -->
<div id="backdrop" class="sheetBackdrop"></div>
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="sheetHeader">
    <div class="sheetTitle">Tools</div>
    <button id="closeSheetBtn" type="button">Close</button>
  </div>

  <div class="card">
    <div><b>Sobriety Date</b></div>
    <div class="muted">Set it once. The app will remember on this device.</div>
    <input id="sobDate" type="date" />
    <div class="row">
      <button id="saveSobBtn" type="button">Save</button>
      <button id="clearSobBtn" type="button">Clear</button>
    </div>
    <div id="sobOut" class="big"></div>
    <div id="sobNext" class="muted" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <div><b>Visiting Streak</b></div>
    <div class="muted">Counts days you opened the app.</div>
    <div id="streakOut" class="big"></div>
    <div id="streakBest" class="muted" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <div><b>Tip</b></div>
    <div class="muted">
      This “Tools” panel is part of the app (GitHub Pages). The reading itself is your real Blogger theme, embedded.
    </div>
  </div>
</div>

<script>
  // Service worker for installability
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }

  const BLOG_URL = "https://recoverymisfits.blogspot.com/";

  // Header buttons
  document.getElementById("openBlogBtn").addEventListener("click", () => {
    window.open(BLOG_URL, "_blank");
  });

  // Bottom sheet open/close
  const toolsBtn = document.getElementById("toolsBtn");
  const sheet = document.getElementById("sheet");
  const backdrop = document.getElementById("backdrop");
  const closeSheetBtn = document.getElementById("closeSheetBtn");

  function openSheet(){
    backdrop.style.display = "block";
    sheet.classList.add("open");
    sheet.setAttribute("aria-hidden", "false");
  }
  function closeSheet(){
    sheet.classList.remove("open");
    sheet.setAttribute("aria-hidden", "true");
    backdrop.style.display = "none";
  }

  toolsBtn.addEventListener("click", openSheet);
  closeSheetBtn.addEventListener("click", closeSheet);
  backdrop.addEventListener("click", closeSheet);

  // ===== Sobriety Date Calculator (local only) =====
  const sobDateEl = document.getElementById("sobDate");
  const sobOut = document.getElementById("sobOut");
  const sobNext = document.getElementById("sobNext");

  function pad2(n){ return String(n).padStart(2,"0"); }

  function loadSobDate(){
    const v = localStorage.getItem("rm_sob_date");
    if (v) sobDateEl.value = v;
    renderSob();
  }

  function daysBetween(startDate, endDate){
    const ms = 24*60*60*1000;
    const a = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    const b = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
    return Math.floor((b - a) / ms);
  }

  function nextMilestone(days){
    const milestones = [1,7,14,30,60,90,180,365,730,1095,1825,3650];
    for (const m of milestones){
      if (m > days) return m;
    }
    return null;
  }

  function renderSob(){
    const v = localStorage.getItem("rm_sob_date");
    if (!v) {
      sobOut.textContent = "";
      sobNext.textContent = "";
      return;
    }
    const start = new Date(v + "T00:00:00");
    const today = new Date();
    const days = daysBetween(start, today);
    const cleanDays = Math.max(0, days);

    sobOut.textContent = cleanDays + " days sober";

    const next = nextMilestone(cleanDays);
    if (next !== null) {
      const remaining = next - cleanDays;
      sobNext.textContent = "Next milestone: " + next + " days (" + remaining + " days to go)";
    } else {
      sobNext.textContent = "You’re in bonus miles now. Keep going.";
    }
  }

  document.getElementById("saveSobBtn").addEventListener("click", () => {
    if (!sobDateEl.value) return;
    localStorage.setItem("rm_sob_date", sobDateEl.value);
    renderSob();
  });

  document.getElementById("clearSobBtn").addEventListener("click", () => {
    localStorage.removeItem("rm_sob_date");
    sobDateEl.value = "";
    renderSob();
  });

  sobDateEl.addEventListener("change", renderSob);

  // ===== Visiting Streak (local only) =====
  const streakOut = document.getElementById("streakOut");
  const streakBest = document.getElementById("streakBest");

  function todayKey(d=new Date()){
    return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
  }

  function yesterdayKey(){
    const d = new Date();
    d.setDate(d.getDate() - 1);
    return todayKey(d);
  }

  function updateStreak(){
    const t = todayKey();
    const last = localStorage.getItem("rm_last_open") || "";
    let streak = Number(localStorage.getItem("rm_streak") || "0");
    let best = Number(localStorage.getItem("rm_best_streak") || "0");

    if (last === t) {
      // already counted today
    } else if (last === yesterdayKey()) {
      streak = streak + 1;
    } else {
      streak = 1;
    }

    localStorage.setItem("rm_last_open", t);
    localStorage.setItem("rm_streak", String(streak));

    if (streak > best) {
      best = streak;
      localStorage.setItem("rm_best_streak", String(best));
    }

    streakOut.textContent = streak + " day streak";
    streakBest.textContent = "Best streak: " + best + " days";
  }

  // Run streak update when app opens
  updateStreak();
  loadSobDate();
</script>

</body>
</html>
