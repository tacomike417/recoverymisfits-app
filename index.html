<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recovery Misfits</title>

  <!-- PWA essentials -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff" />
  <link rel="icon" href="./icon-192.png">

  <style>
    body{
      font-family: Roboto, Arial, sans-serif;
      margin: 0;
      background: #fff;
      color: #111;
    }
    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,.12);
      padding: 12px 14px;
    }
    .title{
      font-size: 18px;
      font-weight: 900;
      margin: 0;
      line-height: 1.2;
    }
    .sub{
      margin: 4px 0 0 0;
      font-size: 13px;
      opacity: .75;
    }
    .wrap{
      max-width: 900px;
      margin: 0 auto;
      padding: 14px;
    }
    .card{
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 14px;
      background: #fff;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    input[type="date"]{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.18);
      font-weight: 700;
    }
    button{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.18);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
    }
    .muted{opacity:.75}
    .content{
      margin-top: 14px;
      line-height: 1.55;
      font-size: 16px;
    }
    /* Make Blogger content look decent */
    .content img{max-width:100%; height:auto; border-radius: 12px;}
    .content blockquote{border-left:4px solid rgba(0,0,0,.15); padding-left:12px; margin-left:0; opacity:.9}
    .content h1,.content h2,.content h3{margin-top:18px}
    a{color:#111}
  </style>
</head>

<body>
  <header>
    <p class="title">Recovery Misfits</p>
    <p class="sub">Today’s reading loads from your Blogger labels (MM-DD).</p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div><b>Label:</b> <span id="labelText">--</span></div>
        <button id="reloadBtn" type="button">Reload</button>
        <button id="openBlogBtn" type="button">Open Blog</button>
      </div>

      <div class="row">
        <label class="muted"><b>Pick a date:</b></label>
        <input id="datePicker" type="date" />
        <button id="loadDateBtn" type="button">Load Date</button>
      </div>

      <div id="status" class="muted" style="margin-top:12px;">Loading…</div>
      <div id="postTitle" style="margin-top:12px;font-weight:900;font-size:18px;"></div>
      <div id="postContent" class="content"></div>
    </div>
  </div>

  <script>
    // REQUIRED: service worker for installability
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js");
    }

    // === CONFIG ===
    const BLOG_BASE = "https://recoverymisfits.blogspot.com";
    // We’ll pull by label like: /-/01-23
    function feedUrlForLabel(label) {
      // JSON-in-script lets us use JSONP to avoid CORS problems.
      return `${BLOG_BASE}/feeds/posts/default/-/${encodeURIComponent(label)}?alt=json-in-script&callback=rmFeedCallback`;
    }

    // === UI ===
    const statusEl = document.getElementById("status");
    const titleEl = document.getElementById("postTitle");
    const contentEl = document.getElementById("postContent");
    const labelTextEl = document.getElementById("labelText");
    const datePicker = document.getElementById("datePicker");

    document.getElementById("openBlogBtn").addEventListener("click", () => {
      window.location.href = BLOG_BASE;
    });

    document.getElementById("reloadBtn").addEventListener("click", () => {
      loadLabel(currentLabel());
    });

    document.getElementById("loadDateBtn").addEventListener("click", () => {
      if (!datePicker.value) return;
      const d = new Date(datePicker.value + "T00:00:00");
      loadLabel(formatLabel(d));
    });

    // === Label helpers ===
    function pad2(n){ return String(n).padStart(2, "0"); }
    function formatLabel(d){
      const mm = pad2(d.getMonth() + 1);
      const dd = pad2(d.getDate());
      return `${mm}-${dd}`;
    }
    function currentLabel(){
      return formatLabel(new Date());
    }

    // Pre-fill date picker with today
    (function initDatePicker(){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = pad2(now.getMonth() + 1);
      const dd = pad2(now.getDate());
      datePicker.value = `${yyyy}-${mm}-${dd}`;
    })();

    // === JSONP loader ===
    function loadJsonp(src){
      // remove old script if any
      const old = document.getElementById("rm-jsonp");
      if (old) old.remove();

      const s = document.createElement("script");
      s.id = "rm-jsonp";
      s.src = src;
      s.onerror = () => {
        statusEl.textContent = "Could not load today’s reading. Tap “Open Blog”.";
      };
      document.head.appendChild(s);
    }

    // JSONP callback (must be global)
    window.rmFeedCallback = function(data){
      try {
        const entries = data && data.feed && data.feed.entry ? data.feed.entry : [];
        if (!entries.length) {
          statusEl.textContent = "No post found for this label yet. (Is today’s label published?)";
          titleEl.textContent = "";
          contentEl.innerHTML = "";
          return;
        }

        // pick first entry
        const e = entries[0];
        const postTitle = (e.title && e.title.$t) ? e.title.$t : "";
        const html = (e.content && e.content.$t) ? e.content.$t : "";

        statusEl.textContent = "";
        titleEl.textContent = postTitle;
        contentEl.innerHTML = html;

      } catch (err) {
        statusEl.textContent = "Loaded something weird — tap “Open Blog” as a fallback.";
        titleEl.textContent = "";
        contentEl.innerHTML = "";
      }
    };

    // === Main loader ===
    function loadLabel(label){
      labelTextEl.textContent = label;
      statusEl.textContent = "Loading…";
      titleEl.textContent = "";
      contentEl.innerHTML = "";

      loadJsonp(feedUrlForLabel(label));
    }

    // Load today by default
    loadLabel(currentLabel());
  </script>
</body>
</html>
