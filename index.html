<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recovery Misfits</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff" />
  <link rel="icon" href="./icon-192.png">

  <style>
    body{
      font-family:Roboto,Arial,sans-serif;
      margin:0;
      background:#fff;
      color:#111;
    }

    header{
      position:sticky;
      top:0;
      z-index:9000;
      background:#fff;
      border-bottom:1px solid rgba(0,0,0,.12);
      padding:12px;
      text-align:center;
    }
    .brand{font-weight:900;font-size:16px;}

    #rm-install-bar{
      display:none;
      position:sticky;
      top:48px;
      z-index:9500;
      background:#fff;
      border-bottom:1px solid rgba(0,0,0,.12);
    }
    #rm-install-inner{
      max-width:980px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    #rm-install-title{font-weight:1000;font-size:13px;}
    #rm-install-sub{font-weight:800;font-size:12px;color:#666;}
    #rm-install-btn{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.18);
      background:#111;
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    #rm-install-close{
      background:none;
      border:none;
      font-size:18px;
      cursor:pointer;
      opacity:.6;
    }

    .iosShareIcon{
      display:inline-flex;
      vertical-align:middle;
      margin-left:6px;
      border:1px solid rgba(0,0,0,.18);
      border-radius:8px;
      padding:2px 8px;
      color:#007AFF;
    }
    .iosShareIcon svg{
      width:18px;height:18px;
    }

    .frameWrap{height:200px;}
    iframe{width:100%;height:100%;border:0;}

    .bottomBar{
      position:fixed;
      left:0;right:0;bottom:0;
      background:#fff;
      border-top:1px solid rgba(0,0,0,.12);
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      z-index:9999;
    }
    .bottomInner{
      max-width:980px;
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr auto;
      gap:10px;
      align-items:stretch;
    }
    .pill{
      border:1px solid rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .label{font-size:12px;font-weight:900;opacity:.7;}
    .value{font-size:14px;font-weight:1000;}
    .hint{font-size:12px;font-weight:900;color:#666;}

    .menuBtn{
      width:44px;
      border:1px solid rgba(0,0,0,.18);
      border-radius:16px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .menuBtn:active{transform:scale(.98);}

    #rm-whisper{
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:6px;
      user-select:none;
      opacity:0;
      transition:opacity .8s ease;
    }
    #rm-whisper.show{opacity:1;}
    .whisper-dot{width:6px;height:6px;border-radius:50%;background:#bbb;flex-shrink:0;}
    .whisper-text{font-size:12px;font-weight:900;color:#777;letter-spacing:.2px;}

    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      z-index:10000;
    }
    .sheet{
      position:fixed;
      left:0;right:0;bottom:0;
      background:#fff;
      border-radius:18px 18px 0 0;
      padding:14px;
      transform:translateY(110%);
      transition:transform .2s ease;
      z-index:10001;
      max-height: calc(92vh - env(safe-area-inset-bottom));
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .sheet.open{transform:translateY(0);}

    input{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.18);
      margin-top:8px;
      font-weight:800;
      box-sizing:border-box;
      font-size:16px;
    }
    textarea{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.18);
      margin-top:8px;
      font-weight:800;
      box-sizing:border-box;
      font-size:16px;
      line-height:1.35;
      resize:vertical;
      min-height:88px;
      font-family:inherit;
    }

    .row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;}

    /* ‚úÖ normalize button sizing across <button> and <a> */
    .btn{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.18);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      color:#111;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-sizing:border-box;
      min-height:44px;      /* <- keeps Trudge the Road same height as others */
      line-height:1.1;
    }
    .btn.primary{background:#111;color:#fff;border-color:rgba(0,0,0,.18);}
    .big{font-size:22px;font-weight:1000;margin-top:10px;}
    .muted{color:#666;font-weight:800;line-height:1.25;}

    /* Gratitude */
    .qLabel{margin-top:12px;font-weight:1000;letter-spacing:.2px;}
    .tinyMeta{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;
      font-weight:900;color:#666;font-size:12px;
    }
    .divider{height:1px;background:rgba(0,0,0,.10);margin:12px 0;}

    .archiveHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;user-select:none;
      padding:10px 12px;border:1px solid rgba(0,0,0,.12);
      border-radius:14px;margin-top:12px;
    }
    .archiveList{
      display:none;margin-top:8px;border:1px solid rgba(0,0,0,.12);
      border-radius:14px;overflow:hidden;max-height:220px;overflow:auto;
    }
    .archiveList.open{display:block;}
    .archiveItem{
      padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.08);
      cursor:pointer;font-weight:900;display:flex;align-items:center;justify-content:space-between;gap:10px;background:#fff;
    }
    .archiveItem:last-child{border-bottom:none;}
    .archiveItem:active{background:#f5f5f5;}
    .chip{
      font-size:12px;font-weight:1000;border:1px solid rgba(0,0,0,.14);
      border-radius:999px;padding:3px 8px;color:#444;
    }

    /* star burst */
    .burstWrap{position:relative; display:inline-flex;}
    .star{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      pointer-events:none;will-change:transform,opacity;font-size:16px;opacity:0;
      animation:starFly .85s ease-out forwards;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.10));
    }
    @keyframes starFly{
      0%{opacity:0;transform:translate(-50%,-50%) scale(.9);}
      10%{opacity:1;}
      100%{opacity:0;transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) rotate(var(--rot)) scale(1.15);}
    }

    /* Burn pad */
    .stepWrap{display:none;}
    .stepWrap.active{display:block;}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
    .chipBtn{
      border:1px solid rgba(0,0,0,.18);
      border-radius:999px;padding:7px 10px;background:#fff;
      font-weight:1000;cursor:pointer;user-select:none;font-size:13px;
    }
    .chipBtn.active{background:#111;color:#fff;border-color:rgba(0,0,0,.18);}
    .burnHeaderLine{margin-top:6px;font-weight:900;color:#666;line-height:1.25;}

    .tinyLink{
      background:none;border:none;padding:0;margin:0;
      color:#111; font-weight:1000; cursor:pointer;
      text-decoration:underline; text-underline-offset:3px;
    }

    .toolBtnRow .btn{
      width:100%;
    }

    .passItOn{
      font-weight:1000;
      color:#666;
      align-self:center;
      white-space:nowrap;
    }

    .shareRow{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
      margin-top:10px;
    }
    @media (max-width:420px){
      .shareRow{
        grid-template-columns: 1fr;
      }
      .passItOn{white-space:normal;}
      .shareRow .btn{width:100%;}
    }

    /* ‚úÖ Prayer modal content */
    .prayerBox{
      margin-top:10px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      padding:12px;
      background:#fff;
      font-weight:900;
      line-height:1.45;
    }
  </style>
</head>

<body>

<header><div class="brand">Recovery Misfits</div></header>

<div id="rm-install-bar">
  <div id="rm-install-inner">
    <div>
      <div id="rm-install-title">Install the app</div>
      <div id="rm-install-sub"></div>
    </div>
    <div>
      <button id="rm-install-btn" type="button">Install</button>
      <button id="rm-install-close" type="button" aria-label="Close">‚úï</button>
    </div>
  </div>
</div>

<div class="frameWrap" id="frameWrap">
  <iframe src="https://recoverymisfits.blogspot.com/"></iframe>
</div>

<div class="bottomBar">
  <div class="bottomInner">

    <div class="pill" id="sobPill">
      <div>
        <div class="label">SOBRIETY</div>
        <div class="value" id="sobValue">Tap to set</div>
      </div>
      <div class="hint" id="sobHint">Tap to set</div>
    </div>

    <div>
      <div class="pill" id="streakPill">
        <div>
          <div class="label">DAILY CHECK-IN</div>
          <div class="value" id="streakValue">‚Äî</div>
        </div>
        <div class="hint">Today</div>
      </div>

      <div id="rm-whisper" aria-hidden="true">
        <span class="whisper-dot" aria-hidden="true"></span>
        <span class="whisper-text"></span>
      </div>
    </div>

    <button class="menuBtn" id="menuBtn" type="button" aria-label="Menu">‚ò∞</button>
  </div>
</div>

<!-- SOBRIETY SHEET -->
<div class="backdrop" id="backdrop"></div>
<div class="sheet" id="sheet">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <h3 style="margin:0;">Sobriety</h3>
    <button class="btn" id="closeSheet" type="button">Close</button>
  </div>
  <div class="muted" style="margin-top:6px;">Set your sobriety date once. Stored on this device.</div>
  <input type="date" id="sobDate">
  <div class="row">
    <button class="btn primary" id="saveSob" type="button">Save</button>
    <button class="btn" id="clearSob" type="button">Clear</button>
  </div>
  <div class="big" id="sobOut"></div>
</div>

<!-- MENU SHEET -->
<div class="backdrop" id="menuBackdrop"></div>
<div class="sheet" id="menuSheet">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <h3 style="margin:0;">Quick Tools</h3>
    <button class="btn" id="closeMenu" type="button">Close</button>
  </div>

  <div class="muted" style="margin-top:6px;">Stuff you might want. Nothing loud.</div>

    <div class="row toolBtnRow" style="margin-top:12px;">
    <a class="btn primary" href="game.html" id="playGameBtn" aria-label="Play Trudge the Road">üéÆ Trudge the Road</a>
  </div>

  <div class="row toolBtnRow" style="margin-top:10px;">
    <a class="btn primary" href="audio.html" id="audioBooksBtn" aria-label="Open Audiobooks">üéß Audiobooks</a>
  </div>

  <div class="row toolBtnRow" style="margin-top:10px;">
    <button class="btn primary" id="gratBtn" type="button">‚≠ê Gratitude Inventory</button>
  </div>


  <div class="shareRow">
    <div class="passItOn">Pass it on: share this app</div>
    <button class="btn" id="shareTextBtn" type="button">By Text</button>
    <button class="btn" id="shareFbBtn" type="button">Facebook</button>
  </div>
</div>

<!-- GRATITUDE SHEET -->
<div class="backdrop" id="gratBackdrop"></div>
<div class="sheet" id="gratSheet">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <h3 style="margin:0;">Gratitude Inventory</h3>
    <button class="btn" id="closeGrat" type="button">Close</button>
  </div>

  <div class="tinyMeta">
    <span id="gratViewing">Viewing: ‚Äî</span>
    <span class="chip" id="gratStatus" style="display:none;">Saved</span>
  </div>

  <div class="divider"></div>

  <div class="qLabel">Where have I been happy today?</div>
  <textarea id="gratHappy"></textarea>

  <div class="qLabel">Where have I been at peace today?</div>
  <textarea id="gratPeace"></textarea>

  <div class="qLabel">Where have I been useful to other people today?</div>
  <textarea id="gratUseful"></textarea>

  <div class="qLabel">Gratitude Journal</div>
  <textarea id="gratJournal" placeholder="God shots, good moments, things you noticed happening for you‚Ä¶"></textarea>

  <div class="row" style="margin-top:12px;">
    <span class="burstWrap">
      <button class="btn primary" id="gratSave" type="button">Save</button>
    </span>
    <button class="btn" id="gratClear" type="button">Clear</button>
  </div>

  <div class="archiveHeader" id="archiveToggle" role="button" aria-expanded="false">
    <div style="font-weight:1000;">Archive <span id="archiveCount" class="chip">0</span></div>
    <div style="font-weight:1000;" id="archiveCaret">‚ñæ</div>
  </div>
  <div class="archiveList" id="archiveList"></div>
</div>

<!-- BURN PAD SHEET -->
<div class="backdrop" id="burnBackdrop"></div>
<div class="sheet" id="burnSheet">

  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <h3 style="margin:0;">Burn Pad</h3>
    <button class="btn" id="closeBurn" type="button">Close</button>
  </div>

  <div class="stepWrap active" id="burnStep1">
    <div class="burnHeaderLine">Write out the text that won‚Äôt be sent</div>

    <div class="qLabel">Name</div>
    <input id="burnName" type="text" placeholder="Who is this about? (optional)">

    <textarea id="burnDraft"
      placeholder="This isn‚Äôt for replaying the struggle. It‚Äôs for getting it out and moving on."
      style="min-height:160px;"></textarea>

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="burnNext" type="button">Next</button>
      <button class="btn" id="burnClear1" type="button">Clear</button>
    </div>
  </div>

  <div class="stepWrap" id="burnStep2">
    <div class="muted" style="margin-top:6px;">
      Strong reactions usually mean something important got touched.
    </div>

    <div style="margin-top:10px;">
      <button class="tinyLink" id="burnToggleSimple" type="button">Show fewer questions</button>
    </div>

    <div class="qLabel">Right now I‚Äôm:</div>
    <div class="chips" id="burnStateChips">
      <button class="chipBtn" type="button" data-v="angry">Angry</button>
      <button class="chipBtn" type="button" data-v="scared">Scared</button>
      <button class="chipBtn" type="button" data-v="hurt">Hurt</button>
      <button class="chipBtn" type="button" data-v="embarrassed">Embarrassed</button>
      <button class="chipBtn" type="button" data-v="tired">Tired</button>
    </div>

    <div class="divider"></div>

    <div class="qLabel">Where was my mistake?</div>
    <textarea id="burnMistake" placeholder="Self-seeking‚Ä¶ lied‚Ä¶ held onto anger too long‚Ä¶ passive aggressive‚Ä¶ withheld a loving attitude‚Ä¶"></textarea>

    <div class="qLabel">Where did I make it worse?</div>
    <textarea id="burnFlames"></textarea>

    <div class="qLabel">What was I trying to control, change, or force?</div>
    <textarea id="burnControl"></textarea>

    <div id="burnAdvanced">
      <div class="qLabel">What‚Äôs actually threatened here?</div>
      <div class="chips" id="burnThreatChips">
        <button class="chipBtn" type="button" data-v="ego">Ego</button>
        <button class="chipBtn" type="button" data-v="fear">Fear</button>
        <button class="chipBtn" type="button" data-v="comfort">Comfort</button>
        <button class="chipBtn" type="button" data-v="image">Image</button>
        <button class="chipBtn" type="button" data-v="security">Security</button>
      </div>

      <div class="qLabel">What‚Äôs the next right move ‚Äî if any?</div>
      <textarea id="burnNextMove" placeholder="Sometimes the move is to do nothing and let things cool."></textarea>

      <div class="qLabel">Who could help me see this more clearly?</div>
      <textarea id="burnWho"></textarea>
    </div>

    <label style="display:flex;align-items:center;gap:10px;margin-top:12px;font-weight:900;color:#444;user-select:none;">
      <input id="burnNotReady" type="checkbox" style="width:auto;margin:0;transform:scale(1.1);">
      I‚Äôm not ready to let this go yet.
    </label>
    <div class="muted" id="burnNotReadyHint" style="margin-top:6px;display:none;">
      That‚Äôs honest. You can still pause it and come back when you‚Äôre ready.
    </div>

    <div class="muted" style="margin-top:12px;">
      Probably not a bad idea to talk this through with someone in recovery.
    </div>
    <div class="muted" style="margin-top:10px;">
      Feelings usually shift if we give them a little time.
    </div>

    <div class="row" style="margin-top:12px;">
      <span class="burstWrap">
        <button class="btn primary" id="burnRelease" type="button">Release it</button>
      </span>
      <button class="btn" id="burnBack" type="button">Back</button>
      <button class="btn" id="burnClear2" type="button">Clear</button>
    </div>
  </div>

</div>

<!-- ‚úÖ SICK MAN'S PRAYER MODAL -->
<div class="backdrop" id="prayerBackdrop"></div>
<div class="sheet" id="prayerSheet" role="dialog" aria-modal="true" aria-labelledby="prayerTitle">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <h3 id="prayerTitle" style="margin:0;">Sick Man‚Äôs Prayer</h3>
    <button class="btn" id="closePrayerX" type="button">Close</button>
  </div>

  <div class="prayerBox" style="margin-top:12px;">
    This is a sick man. How can I be helpful to him?<br>
    God save me from being angry.<br>
    Thy will be done.
  </div>

  <div class="row" style="margin-top:14px;">
    <button class="btn primary" id="prayerDone" type="button">Let it go</button>
  </div>
</div>

<!-- iOS INSTALL SHEET -->
<div class="backdrop" id="iosBackdrop"></div>
<div class="sheet" id="iosSheet">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <h3 style="margin:0;">Add to Home Screen</h3>
    <button class="btn" id="closeIOS" type="button">Close</button>
  </div>

  <div style="margin-top:12px;font-weight:900;line-height:1.45;">
    <div style="margin-bottom:12px;">
      <b>1)</b> Tap the iPhone <b>Share</b> button
      <span style="margin-left:6px;border:1px solid rgba(0,0,0,.18);border-radius:8px;padding:2px 8px;font-weight:1000;">
        <span class="iosShareIcon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="5" y="9" width="14" height="12" rx="2" stroke="currentColor" stroke-width="2"/>
          </svg>
        </span>
      </span>
    </div>
    <div style="margin-bottom:12px;">
      <b>2)</b> Scroll and tap <b>Add to Home Screen</b>
    </div>
    <div><b>3)</b> Tap <b>Add</b></div>
  </div>

  <div class="muted" style="margin-top:12px;">Tip: this works best in Safari (some in-app browsers block it).</div>
</div>

<script>
  if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");

  const frameWrap = document.getElementById("frameWrap");
  function setFrameHeight(){
    const headerH = document.querySelector("header").offsetHeight || 48;
    const installBarEl = document.getElementById("rm-install-bar");
    const installH = (installBarEl && getComputedStyle(installBarEl).display !== "none") ? installBarEl.offsetHeight : 0;
    const bottomH = document.querySelector(".bottomBar").offsetHeight || 70;
    const total = window.innerHeight - headerH - installH - bottomH;
    frameWrap.style.height = Math.max(220, total) + "px";
  }
  window.addEventListener("resize", setFrameHeight);

  function isStandalone(){
    const mql = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
    const iosStandalone = window.navigator.standalone === true;
    return !!(mql || iosStandalone);
  }

  /* Install Bar */
  const installBar = document.getElementById("rm-install-bar");
  const installBtn = document.getElementById("rm-install-btn");
  const installClose = document.getElementById("rm-install-close");
  const installSub = document.getElementById("rm-install-sub");

  const ua = navigator.userAgent || "";
  const isIOS = /iphone|ipad|ipod/i.test(ua);
  const isInAppBrowserIOS = isIOS && /(fbav|fban|instagram|line\/|wv)/i.test(ua);
  let deferredPrompt = null;

  function showInstallBar(msg){
    if (isStandalone()) return;
    installSub.textContent = msg || "";
    installBar.style.display = "block";
    setFrameHeight();
  }
  function hideInstallBar(){
    installBar.style.display = "none";
    setFrameHeight();
  }

  if (!isStandalone()) {
    if (isIOS) {
      showInstallBar(isInAppBrowserIOS ? "Open in Safari to install." : "Tap Install for iPhone steps.");
      installBtn.textContent = "Add to Home Screen";
    } else {
      showInstallBar("Android: tap Install (or Chrome menu ‚ãÆ ‚Üí Install app).");
      installBtn.textContent = "Install";
      installBtn.disabled = true;
    }
  }

  const iosBackdrop = document.getElementById("iosBackdrop");
  const iosSheet = document.getElementById("iosSheet");
  function openIOS(){ iosBackdrop.style.display="block"; iosSheet.classList.add("open"); }
  function closeIOS(){ iosSheet.classList.remove("open"); iosBackdrop.style.display="none"; }
  iosBackdrop.onclick = closeIOS;
  document.getElementById("closeIOS").onclick = closeIOS;

  if (isIOS) {
    installBtn.onclick = (e) => { e.preventDefault(); openIOS(); };
  } else {
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.disabled = false;
      showInstallBar("Android: tap Install now.");
    });

    installBtn.onclick = async (e) => {
      e.preventDefault();
      if (!deferredPrompt) {
        showInstallBar("Try: Chrome menu (‚ãÆ) ‚Üí Install app.");
        return;
      }
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    };
  }

  installClose.onclick = (e) => { e.preventDefault(); hideInstallBar(); };
  window.addEventListener("appinstalled", () => hideInstallBar());
  if (isStandalone()) hideInstallBar();

  /* Menu */
  const menuBackdrop = document.getElementById("menuBackdrop");
  const menuSheet = document.getElementById("menuSheet");
  const menuBtn = document.getElementById("menuBtn");

  function openMenu(){ menuBackdrop.style.display="block"; menuSheet.classList.add("open"); }
  function closeMenu(){ menuSheet.classList.remove("open"); menuBackdrop.style.display="none"; }

  menuBtn.onclick = openMenu;
  menuBackdrop.onclick = closeMenu;
  document.getElementById("closeMenu").onclick = closeMenu;

  /* Share */
  const SHARE_URL = "https://recoverymisfits.blogspot.com/";
  const SHARE_TEXT = "This has been helping me lately. No hype, just solid. " + SHARE_URL;

  document.getElementById("shareTextBtn").onclick = () => {
    window.location.href = "sms:?&body=" + encodeURIComponent(SHARE_TEXT);
  };
  document.getElementById("shareFbBtn").onclick = () => {
    const fb = "https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(SHARE_URL);
    window.open(fb, "_blank", "noopener,noreferrer");
  };

  /* Sobriety + check-in */
  const LS_DATE   = "rm_sob_date";
  const LS_MODE   = "rm_sob_mode";
  const LS_STREAK = "rm_streak";
  const LS_LAST   = "rm_last";

  const sobValue = document.getElementById("sobValue");
  const sobHint  = document.getElementById("sobHint");
  const sobDate  = document.getElementById("sobDate");
  const sobOut   = document.getElementById("sobOut");

  const sheet = document.getElementById("sheet");
  const backdrop = document.getElementById("backdrop");

  function openSheet(){
    backdrop.style.display="block";
    sheet.classList.add("open");
    setTimeout(() => {
      sobDate.focus({ preventScroll: true });
      if (sobDate.showPicker) sobDate.showPicker();
    }, 150);
  }
  function closeSheet(){ sheet.classList.remove("open"); backdrop.style.display="none"; }
  backdrop.onclick = closeSheet;
  document.getElementById("closeSheet").onclick = closeSheet;

  function getMode(){
    let mode = localStorage.getItem(LS_MODE);
    if (!mode) { mode = "days"; localStorage.setItem(LS_MODE, mode); }
    return mode;
  }

  function renderSob(){
    const v = localStorage.getItem(LS_DATE);
    const mode = getMode();
    if(!v){
      sobValue.textContent="Tap to set";
      sobHint.textContent="Tap to set";
      sobOut.textContent="";
      return;
    }
    const d0 = new Date(v + "T00:00:00");
    const d1 = new Date();
    const days = Math.max(0, Math.floor((d1-d0)/(1000*60*60*24)));

    if (mode === "date") {
      sobValue.textContent = v;
      sobHint.textContent  = "Tap: show days";
    } else {
      sobValue.textContent = days + " days";
      sobHint.textContent  = "Tap: show date";
    }
    sobOut.textContent = days + " days sober";
  }

  document.getElementById("sobPill").onclick = () => {
    const v = localStorage.getItem(LS_DATE);
    if(!v){ openSheet(); return; }
    const mode = getMode();
    localStorage.setItem(LS_MODE, mode === "date" ? "days" : "date");
    renderSob();
  };
  document.getElementById("streakPill").onclick = () => openSheet();

  document.getElementById("saveSob").onclick = () => {
    if(sobDate.value){
      localStorage.setItem(LS_DATE, sobDate.value);
      renderSob();
      closeSheet();
    }
  };
  document.getElementById("clearSob").onclick = () => {
    localStorage.removeItem(LS_DATE);
    renderSob();
    closeSheet();
  };

  function updateStreak(){
    const today = new Date().toISOString().slice(0,10);
    const yesterday = new Date(Date.now()-86400000).toISOString().slice(0,10);
    const last = localStorage.getItem(LS_LAST);
    let streak = Number(localStorage.getItem(LS_STREAK) || 0);

    if(last !== today){
      streak = (last === yesterday) ? streak + 1 : 1;
      localStorage.setItem(LS_LAST, today);
      localStorage.setItem(LS_STREAK, String(streak));
    }
    document.getElementById("streakValue").textContent = streak + "üî•";
  }

  /* Whisper */
  const WHISPER_KEY_DATE = "rm_whisper_date";
  const WHISPER_KEY_TEXT = "rm_whisper_text";
  const WHISPERS = [
    "A few people re-read this lately","This one‚Äôs getting re-read","This one‚Äôs making the rounds",
    "This hit somebody else too","You weren‚Äôt the only one here","Others paused on this one",
    "This one drew a second look","This one slowed someone down","This one didn‚Äôt go unnoticed",
    "More than one set of eyes here","Someone else needed this too","This one met a few people where they were",
    "You‚Äôre in quiet company here","This one landed for somebody","A few folks stayed with this one",
    "This one found its way around","Others sat with this for a bit","You weren‚Äôt alone with this thought",
    "This one didn‚Äôt just pass by","Not the only one to read this","Shared moment today",
    "Quietly revisited today","This one stayed today","Others were here today"
  ];
  function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function getTodayISO(){ return new Date().toISOString().slice(0,10); }

  function renderWhisper(){
    const wrap = document.getElementById("rm-whisper");
    const textEl = document.querySelector(".whisper-text");
    if(!wrap || !textEl) return;

    const today = getTodayISO();
    const savedDate = localStorage.getItem(WHISPER_KEY_DATE);
    const savedText = localStorage.getItem(WHISPER_KEY_TEXT);

    let text = savedText;
    if(savedDate !== today || !savedText){
      text = pickRandom(WHISPERS);
      localStorage.setItem(WHISPER_KEY_DATE, today);
      localStorage.setItem(WHISPER_KEY_TEXT, text);
    }
    textEl.textContent = text;
    setTimeout(() => wrap.classList.add("show"), 900);
  }

  /* star burst */
  function burstStars(onButtonEl){
    const wrap = onButtonEl.closest(".burstWrap") || onButtonEl.parentElement;
    if(!wrap) return;
    const emojis = ["‚≠ê","‚ú®","üåü"];
    const count = 14;
    for(let i=0;i<count;i++){
      const s = document.createElement("span");
      s.className="star";
      s.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      s.style.setProperty("--dx", (Math.random()*90 - 45).toFixed(0) + "px");
      s.style.setProperty("--dy", (Math.random()*-80 - 20).toFixed(0) + "px");
      s.style.setProperty("--rot", (Math.random()*220 - 110).toFixed(0) + "deg");
      s.style.animationDelay = (Math.random()*0.08).toFixed(2)+"s";
      wrap.appendChild(s);
      setTimeout(() => s.remove(), 950);
    }
  }

  /* Gratitude */
  const GRAT_INDEX_KEY = "rm_grat_index";
  const gratBackdrop = document.getElementById("gratBackdrop");
  const gratSheet = document.getElementById("gratSheet");

  const gratViewing = document.getElementById("gratViewing");
  const gratStatus = document.getElementById("gratStatus");

  const gratHappy = document.getElementById("gratHappy");
  const gratPeace = document.getElementById("gratPeace");
  const gratUseful = document.getElementById("gratUseful");
  const gratJournal = document.getElementById("gratJournal");

  const archiveToggle = document.getElementById("archiveToggle");
  const archiveList = document.getElementById("archiveList");
  const archiveCount = document.getElementById("archiveCount");
  const archiveCaret = document.getElementById("archiveCaret");

  let currentGratDate = null;

  function gratKey(dateISO){ return "rm_grat_" + dateISO; }
  function readIndex(){
    try{
      const raw = localStorage.getItem(GRAT_INDEX_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function writeIndex(arr){ localStorage.setItem(GRAT_INDEX_KEY, JSON.stringify(arr)); }

  function saveEntry(dateISO, data){
    localStorage.setItem(gratKey(dateISO), JSON.stringify(data));
    let idx = readIndex();
    if(!idx.includes(dateISO)){ idx.unshift(dateISO); writeIndex(idx); }
    else { idx = [dateISO].concat(idx.filter(d => d !== dateISO)); writeIndex(idx); }
  }

  function loadEntry(dateISO){
    const raw = localStorage.getItem(gratKey(dateISO));
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }

  function setStatusSaved(){
    gratStatus.style.display="inline-flex";
    gratStatus.textContent="Saved";
    setTimeout(() => gratStatus.style.display = "none", 1000);
  }

  function openGrat(dateISO){
    currentGratDate = dateISO || getTodayISO();
    gratViewing.textContent = "Viewing: " + currentGratDate;

    const entry = loadEntry(currentGratDate);
    gratHappy.value = entry?.happy || "";
    gratPeace.value = entry?.peace || "";
    gratUseful.value = entry?.useful || "";
    gratJournal.value = entry?.journal || "";

    gratBackdrop.style.display="block";
    gratSheet.classList.add("open");
    renderArchive();
  }
  function closeGrat(){ gratSheet.classList.remove("open"); gratBackdrop.style.display="none"; }

  gratBackdrop.onclick = closeGrat;
  document.getElementById("closeGrat").onclick = closeGrat;

  document.getElementById("gratBtn").onclick = () => { closeMenu(); openGrat(getTodayISO()); };

  archiveToggle.onclick = () => {
    const isOpen = archiveList.classList.toggle("open");
    archiveToggle.setAttribute("aria-expanded", String(isOpen));
    archiveCaret.textContent = isOpen ? "‚ñ¥" : "‚ñæ";
  };

  function renderArchive(){
    const idx = readIndex();
    archiveCount.textContent = String(idx.length);
    archiveList.innerHTML = "";

    if(idx.length === 0){
      const empty = document.createElement("div");
      empty.className="archiveItem";
      empty.style.cursor="default";
      empty.innerHTML = `<span style="opacity:.7;font-weight:900;">No saved entries yet</span><span class="chip">‚Äî</span>`;
      archiveList.appendChild(empty);
      return;
    }

    idx.forEach(dateISO => {
      const row = document.createElement("div");
      row.className="archiveItem";
      const isToday = (dateISO === getTodayISO());
      row.innerHTML = `<span>${dateISO}</span><span class="chip">${isToday ? "today" : "open"}</span>`;
      row.onclick = () => {
        currentGratDate = dateISO;
        gratViewing.textContent = "Viewing: " + currentGratDate;
        const entry = loadEntry(currentGratDate);
        gratHappy.value = entry?.happy || "";
        gratPeace.value = entry?.peace || "";
        gratUseful.value = entry?.useful || "";
        gratJournal.value = entry?.journal || "";
      };
      archiveList.appendChild(row);
    });
  }

  document.getElementById("gratSave").onclick = () => {
    const dateISO = currentGratDate || getTodayISO();
    const payload = {
      date: dateISO,
      happy: gratHappy.value.trim(),
      peace: gratPeace.value.trim(),
      useful: gratUseful.value.trim(),
      journal: gratJournal.value.trim()
    };
    try{
      saveEntry(dateISO, payload);
      setStatusSaved();
      burstStars(document.getElementById("gratSave"));
      renderArchive();
    }catch(e){
      gratStatus.style.display="inline-flex";
      gratStatus.textContent="Couldn‚Äôt save";
      setTimeout(() => gratStatus.style.display="none", 1400);
    }
  };
  document.getElementById("gratClear").onclick = () => {
    gratHappy.value=""; gratPeace.value=""; gratUseful.value=""; gratJournal.value="";
  };

  /* Burn Pad (no save) */
  const burnBackdrop = document.getElementById("burnBackdrop");
  const burnSheet = document.getElementById("burnSheet");

  const burnStep1 = document.getElementById("burnStep1");
  const burnStep2 = document.getElementById("burnStep2");

  const burnName = document.getElementById("burnName");
  const burnDraft = document.getElementById("burnDraft");
  const burnMistake = document.getElementById("burnMistake");
  const burnFlames = document.getElementById("burnFlames");
  const burnControl = document.getElementById("burnControl");
  const burnNextMove = document.getElementById("burnNextMove");
  const burnWho = document.getElementById("burnWho");

  const burnThreatChips = document.getElementById("burnThreatChips");
  let burnThreat = "";

  const burnStateChips = document.getElementById("burnStateChips");
  let burnState = "";

  const burnAdvanced = document.getElementById("burnAdvanced");
  const burnToggleSimple = document.getElementById("burnToggleSimple");
  let burnSimple = false;

  const burnNotReady = document.getElementById("burnNotReady");
  const burnNotReadyHint = document.getElementById("burnNotReadyHint");
  const burnReleaseBtn = document.getElementById("burnRelease");

  function showBurnStep(n){
    if(n===1){ burnStep1.classList.add("active"); burnStep2.classList.remove("active"); }
    else { burnStep1.classList.remove("active"); burnStep2.classList.add("active"); }
  }
  function openBurn(){
    burnBackdrop.style.display="block";
    burnSheet.classList.add("open");
    showBurnStep(1);
    setTimeout(() => burnName.focus({preventScroll:true}), 120);
  }
  function closeBurn(){ burnSheet.classList.remove("open"); burnBackdrop.style.display="none"; }

  function resetNotReadyUI(){
    burnNotReady.checked = false;
    burnNotReadyHint.style.display = "none";
    burnReleaseBtn.textContent = "Release it";
  }
  function resetSimpleUI(){
    burnSimple = false;
    if(burnAdvanced) burnAdvanced.style.display = "";
    if(burnToggleSimple) burnToggleSimple.textContent = "Show fewer questions";
  }
  function clearBurnAll(){
    burnName.value = "";
    burnDraft.value=""; burnMistake.value=""; burnFlames.value=""; burnControl.value="";
    if(burnNextMove) burnNextMove.value=""; if(burnWho) burnWho.value="";
    burnThreat=""; burnState="";
    if(burnThreatChips) burnThreatChips.querySelectorAll(".chipBtn").forEach(b=>b.classList.remove("active"));
    if(burnStateChips) burnStateChips.querySelectorAll(".chipBtn").forEach(b=>b.classList.remove("active"));
    resetNotReadyUI();
    resetSimpleUI();
  }

  burnBackdrop.onclick = closeBurn;
  document.getElementById("closeBurn").onclick = closeBurn;
  document.getElementById("burnBtn").onclick = () => { closeMenu(); openBurn(); };

  document.getElementById("burnNext").onclick = () => { showBurnStep(2); setTimeout(() => burnMistake.focus({preventScroll:true}), 80); };
  document.getElementById("burnBack").onclick = () => { showBurnStep(1); setTimeout(() => burnName.focus({preventScroll:true}), 80); };

  document.getElementById("burnClear1").onclick = () => { burnName.value=""; burnDraft.value=""; };
  document.getElementById("burnClear2").onclick = () => {
    burnMistake.value=""; burnFlames.value=""; burnControl.value="";
    if(burnNextMove) burnNextMove.value=""; if(burnWho) burnWho.value="";
    burnThreat=""; burnState="";
    if(burnThreatChips) burnThreatChips.querySelectorAll(".chipBtn").forEach(b=>b.classList.remove("active"));
    if(burnStateChips) burnStateChips.querySelectorAll(".chipBtn").forEach(b=>b.classList.remove("active"));
    resetNotReadyUI();
    resetSimpleUI();
  };

  if(burnThreatChips){
    burnThreatChips.addEventListener("click", (e) => {
      const btn = e.target.closest(".chipBtn");
      if(!btn) return;
      const v = btn.getAttribute("data-v") || "";
      const isActive = btn.classList.contains("active");

      burnThreatChips.querySelectorAll(".chipBtn").forEach(b=>b.classList.remove("active"));
      if(!isActive){ btn.classList.add("active"); burnThreat = v; }
      else { burnThreat = ""; }
    });
  }

  if(burnStateChips){
    burnStateChips.addEventListener("click", (e) => {
      const btn = e.target.closest(".chipBtn");
      if(!btn) return;
      const v = btn.getAttribute("data-v") || "";
      const isActive = btn.classList.contains("active");

      burnStateChips.querySelectorAll(".chipBtn").forEach(b=>b.classList.remove("active"));
      if(!isActive){ btn.classList.add("active"); burnState = v; }
      else { burnState = ""; }
    });
  }

  if(burnToggleSimple){
    burnToggleSimple.onclick = () => {
      burnSimple = !burnSimple;
      if(burnAdvanced) burnAdvanced.style.display = burnSimple ? "none" : "";
      burnToggleSimple.textContent = burnSimple ? "Show all questions" : "Show fewer questions";
    };
  }

  burnNotReady.addEventListener("change", () => {
    if(burnNotReady.checked){
      burnReleaseBtn.textContent="Pause it";
      burnNotReadyHint.style.display="block";
    } else {
      burnReleaseBtn.textContent="Release it";
      burnNotReadyHint.style.display="none";
    }
  });

  /* ‚úÖ Sick Man‚Äôs Prayer modal */
  const prayerBackdrop = document.getElementById("prayerBackdrop");
  const prayerSheet = document.getElementById("prayerSheet");
  const prayerDone = document.getElementById("prayerDone");
  const closePrayerX = document.getElementById("closePrayerX");

  function openPrayer(){
    prayerBackdrop.style.display="block";
    prayerSheet.classList.add("open");
    setTimeout(() => prayerDone.focus({preventScroll:true}), 120);
  }
  function closePrayer(){
    prayerSheet.classList.remove("open");
    prayerBackdrop.style.display="none";
  }
  prayerBackdrop.onclick = closePrayer;
  closePrayerX.onclick = closePrayer;
  prayerDone.onclick = closePrayer;

  burnReleaseBtn.onclick = () => {
    burstStars(burnReleaseBtn);

    /* If not ready: PAUSE (do not clear), just close */
    if (burnNotReady.checked){
      closeBurn();
      return;
    }

    /* Release: clear + close + show Sick Man's Prayer */
    clearBurnAll();
    closeBurn();
    openPrayer();
  };

  /* Init */
  (function init(){
    const v = localStorage.getItem(LS_DATE);
    if (v) sobDate.value = v;
    sobDate.max = new Date().toISOString().slice(0,10);

    updateStreak();
    renderSob();
    renderWhisper();
    setFrameHeight();
  })();
</script>

</body>
</html>
