<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recovery Misfits</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff" />
  <link rel="icon" href="./icon-192.png">

  <style>
    body{
      font-family: Roboto, Arial, sans-serif;
      margin: 0;
      background: #fff;
      color: #111;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 9999;
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,.12);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      font-weight: 900;
      font-size: 16px;
    }
    button{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.18);
      background: #fff;
      font-weight: 900;
      cursor: pointer;
    }

    .frameWrap{
      height: calc(100vh - 52px - 62px);
    }
    iframe{
      width: 100%;
      height: 100%;
      border: 0;
    }

    /* Bottom bar */
    .bottomBar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #fff;
      border-top: 1px solid rgba(0,0,0,.12);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .bottomInner{
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pill{
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor: pointer;
    }
    .label{
      font-size: 12px;
      font-weight: 800;
      opacity: .7;
    }
    .value{
      font-size: 14px;
      font-weight: 1000;
    }
    .hint{
      font-size: 12px;
      font-weight: 900;
      opacity: .6;
      white-space: nowrap;
    }

    /* Sheet */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
    }
    .sheet{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #fff;
      border-radius: 18px 18px 0 0;
      padding: 14px;
      transform: translateY(110%);
      transition: transform .2s ease;
    }
    .sheet.open{ transform: translateY(0); }
    input{
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.18);
      margin-top: 8px;
      font-weight: 700;
      box-sizing: border-box;
    }
    .row{ display:flex; gap:10px; margin-top:10px; }
    .big{ font-size: 22px; font-weight: 1000; margin-top: 10px; }
    .muted{ opacity:.75; }
  </style>
</head>

<body>

<header>
  <div class="brand">Recovery Misfits</div>
  <button type="button" onclick="window.open('https://recoverymisfits.blogspot.com/')">Open Blog</button>
</header>

<div class="frameWrap">
  <iframe src="https://recoverymisfits.blogspot.com/"></iframe>
</div>

<!-- Bottom Bar -->
<div class="bottomBar">
  <div class="bottomInner">

    <div class="pill" id="sobPill" role="button" aria-label="Sobriety">
      <div>
        <div class="label">SOBRIETY</div>
        <div class="value" id="sobValue">Tap to set</div>
      </div>
      <div class="hint" id="sobHint">Tap to set</div>
    </div>

    <div class="pill" id="streakPill" role="button" aria-label="Streak">
      <div>
        <div class="label">STREAK</div>
        <div class="value" id="streakValue">â€”</div>
      </div>
      <div class="hint">Details</div>
    </div>

  </div>
</div>

<!-- Sheet -->
<div class="backdrop" id="backdrop"></div>
<div class="sheet" id="sheet" aria-hidden="true">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <h3 style="margin:0;">Sobriety</h3>
    <button id="closeSheet" type="button">Close</button>
  </div>

  <div class="muted" style="margin-top:6px;">Set your sobriety date once. Stored on this device.</div>

  <input type="date" id="sobDate">

  <div class="row">
    <button id="saveSob" type="button">Save</button>
    <button id="clearSob" type="button">Clear</button>
  </div>

  <div class="big" id="sobOut"></div>
</div>

<script>
  if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");

  const LS_DATE  = "rm_sob_date";
  const LS_MODE  = "rm_sob_mode";   // "days" | "date"
  const LS_STREAK = "rm_streak";
  const LS_LAST   = "rm_last";

  const sobValue = document.getElementById("sobValue");
  const sobHint  = document.getElementById("sobHint");
  const sobDate  = document.getElementById("sobDate");
  const sobOut   = document.getElementById("sobOut");
  const streakValue = document.getElementById("streakValue");

  const sheet = document.getElementById("sheet");
  const backdrop = document.getElementById("backdrop");
  const closeSheetBtn = document.getElementById("closeSheet");

  function openSheet(){
    backdrop.style.display = "block";
    sheet.classList.add("open");
    sheet.setAttribute("aria-hidden","false");
  }
  function closeSheet(){
    sheet.classList.remove("open");
    sheet.setAttribute("aria-hidden","true");
    backdrop.style.display = "none";
  }

  backdrop.onclick = closeSheet;
  closeSheetBtn.onclick = closeSheet;

  function daysBetween(a,b){
    return Math.floor((b-a)/(1000*60*60*24));
  }

  function getMode(){
    let mode = localStorage.getItem(LS_MODE);
    if (!mode) {
      mode = "days";
      localStorage.setItem(LS_MODE, mode);
    }
    return mode;
  }

  function renderSob(){
    const v = localStorage.getItem(LS_DATE);
    const mode = getMode();

    // If not set yet
    if(!v){
      sobValue.textContent = "Tap to set";
      sobHint.textContent = "Tap to set";
      sobOut.textContent = "";
      return;
    }

    const d0 = new Date(v + "T00:00:00");
    const d1 = new Date();
    const days = Math.max(0, daysBetween(d0, d1));

    // Main value on left
    if (mode === "date") {
      sobValue.textContent = "Sober: " + v;
      // Hint shows what tap will switch to
      sobHint.textContent = "Day count";
    } else {
      sobValue.textContent = "Sober: " + days + "d";
      sobHint.textContent = "Sobriety date";
    }

    // Sheet always shows day count
    sobOut.textContent = days + " days sober";
  }

  document.getElementById("sobPill").onclick = () => {
    const v = localStorage.getItem(LS_DATE);

    // If not set, tap opens set sheet
    if(!v){
      openSheet();
      return;
    }

    // If set, tap flips mode
    const mode = getMode();
    localStorage.setItem(LS_MODE, mode === "date" ? "days" : "date");
    renderSob();
  };

  document.getElementById("streakPill").onclick = () => {
    // Optional: open the sheet for now (or build a streak sheet later)
    openSheet();
  };

  document.getElementById("saveSob").onclick = () => {
    if(sobDate.value){
      localStorage.setItem(LS_DATE, sobDate.value);
      renderSob();
      closeSheet();
    }
  };

  document.getElementById("clearSob").onclick = () => {
    localStorage.removeItem(LS_DATE);
    renderSob();
    closeSheet();
  };

  function updateStreak(){
    const today = new Date().toISOString().slice(0,10);
    const yesterday = new Date(Date.now()-86400000).toISOString().slice(0,10);

    const last = localStorage.getItem(LS_LAST);
    let streak = Number(localStorage.getItem(LS_STREAK) || 0);

    if(last !== today){
      streak = (last === yesterday) ? streak + 1 : 1;
      localStorage.setItem(LS_LAST, today);
      localStorage.setItem(LS_STREAK, String(streak));
    }

    streakValue.textContent = streak + "ðŸ”¥";
  }

  // Init
  // If there is a saved date, prefill the sheet input
  (function initDateInput(){
    const v = localStorage.getItem(LS_DATE);
    if (v) sobDate.value = v;
  })();

  updateStreak();
  renderSob();
</script>

</body>
</html>
