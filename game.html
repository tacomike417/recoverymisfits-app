<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Trudge the Road</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
html, body {
  margin:0; padding:0; height:100%;
  background:#000; overflow:hidden;
  font-family:"Press Start 2P", monospace;
}
canvas { display:block; width:100vw; height:100vh; }
#pauseBtn{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  font-family:"Press Start 2P", monospace;
  font-size:10px;
  padding:10px 14px;
  background:#111;
  color:#fff;
  border:1px solid #444;
  border-radius:8px;
  opacity:.92;
  z-index:10;
  display:none;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<audio id="bgm" loop preload="auto">
  <source src="E-Lot - 8-Bit Boss.mp3" type="audio/mpeg">
</audio>

<button id="pauseBtn">PAUSE / BREATHE</button>

<script>
(() => {
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const bgm = document.getElementById("bgm");

function resize(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = innerWidth * dpr;
  canvas.height = innerHeight * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize", resize);
resize();

/* =======================
   SPRITE
======================= */
const runnerImg = new Image();
runnerImg.src = "./runner.png";
let runnerReady = false;
runnerImg.onload = () => runnerReady = true;

const RUNNER_FRAMES = 2;
let runnerFrame = 0;
let runnerTick = 0;

/* =======================
   MODES
======================= */
let mode = "title"; // title | countdown | play | pause | gameover | ending
function setMode(m){
  mode = m;
  pauseBtn.style.display =
    (mode === "play" || mode === "pause") ? "block" : "none";
}

/* =======================
   PLAYER / LANES
======================= */
const LANE_COUNT = 3;
const player = {
  x: 140,
  y: 0,
  w: 72,
  h: 96,
  lane: 1,
  laneTarget: 1
};

function laneCenters(){
  const top = 190;
  const bottom = innerHeight - 160;
  const gap = (bottom - top) / (LANE_COUNT - 1);
  return [top, top+gap, bottom];
}

/* =======================
   GAME STATE
======================= */
const MAX_LIVES = 5;
let lives = MAX_LIVES;
let stepIndex = 0;
let obstaclesPassed = 0;
let invuln = 0;
let slowTimer = 0;
let slowMo = 0;
let warmupFrames = 0;

let prestige = 0;
let prestigeSpeedBoost = 0;

const obstacles = [];
const bonuses = [];
const microClouds = [];
const stepTokens = [];

let banner = null;

/* =======================
   CONTENT
======================= */
const obstaclesPool = [
  "Anger","Resentment","Fear","Ego","Anxiety","Guilt","Shame",
  "Control","Isolation","Overthinking","People-pleasing",
  "Self-pity","Dishonesty","Avoidance","Restless","Irritable"
];

const bonusesPool = [
  "Go to a meeting",
  "Call a friend",
  "Call your sponsor",
  "Pray / pause",
  "Write it down"
];

const steps = [
  ["STEP 1","HONESTY"],
  ["STEP 2","HOPE"],
  ["STEP 3","FAITH"],
  ["STEP 4","COURAGE"],
  ["STEP 5","INTEGRITY"],
  ["STEP 6","WILLINGNESS"],
  ["STEP 7","HUMILITY"],
  ["STEP 8","LOVE"],
  ["STEP 9","DISCIPLINE"],
  ["STEP 10","PERSEVERANCE"],
  ["STEP 11","AWARENESS"],
  ["STEP 12","SERVICE"]
];

const calmWhispers = [
  "Breathe.",
  "You’re not alone.",
  "Easy does it.",
  "Stay in the middle."
];

/* =======================
   INPUT
======================= */
function startMusic(){
  if (bgm.paused){
    bgm.volume = 0.22;
    bgm.play().catch(()=>{});
  }
}

function onTap(){
  startMusic();

  if (mode === "title"){ startCountdown(); return; }
  if (mode === "gameover" || mode === "ending"){
    setMode("title");
    return;
  }
  if (mode !== "play") return;

  player.laneTarget = (player.laneTarget + 1) % LANE_COUNT;
}

addEventListener("keydown", e => e.code==="Space" && onTap());
addEventListener("mousedown", onTap, {passive:true});
addEventListener("touchstart", onTap, {passive:true});

pauseBtn.onclick = () => {
  if (mode === "play"){
    bgm.pause();
    setMode("pause");
  } else if (mode === "pause"){
    bgm.play().catch(()=>{});
    setMode("play");
  }
};

/* =======================
   TITLE / COUNTDOWN
======================= */
let titleTimer = 0;
let countdown = 3;
let countdownTick = 0;

function startCountdown(){
  resetRun();
  countdown = 3;
  countdownTick = 0;
  setMode("countdown");
}

/* =======================
   RESET
======================= */
function resetRun(){
  lives = MAX_LIVES;
  stepIndex = 0;
  obstacles.length = 0;
  bonuses.length = 0;
  microClouds.length = 0;
  stepTokens.length = 0;
  obstaclesPassed = 0;
  invuln = 0;
  slowTimer = 0;
  warmupFrames = 0;

  const lanes = laneCenters();
  player.lane = 1;
  player.laneTarget = 1;
  player.y = lanes[1] - player.h/2;

  banner = {text:"STEP 1 — HONESTY", sub:"Go through the steps IN ORDER", t:0};
}

/* =======================
   GAME LOOP
======================= */
function speed(){
  let s = 3.6 + prestigeSpeedBoost;
  s += stepIndex * 0.2;
  s += Math.min(1.6, obstaclesPassed * 0.0025);
  if (slowTimer > 0) s *= 0.7;
  if (slowMo > 0) s *= 0.4;
  if (warmupFrames < 900) s *= 0.85;
  return s;
}

function spawnObstacle(xOff=0, lane=null){
  const label = obstaclesPool[Math.random()*obstaclesPool.length|0];
  const lanes = laneCenters();
  const l = lane===null ? Math.random()*3|0 : lane;
  obstacles.push({
    x: innerWidth + xOff,
    y: lanes[l] - 28,
    w: 260,
    h: 46,
    lane: l,
    label
  });
}

function spawnBonus(){
  const label = bonusesPool[Math.random()*bonusesPool.length|0];
  const lanes = laneCenters();
  bonuses.push({
    x: innerWidth,
    y: lanes[1] - 22,
    w: 360,
    h: 44,
    lane: 1,
    label
  });
}

function spawnStep(){
  if (stepIndex >= 12) return;
  const lanes = laneCenters();
  const lane = Math.random()*3|0;
  stepTokens.push({
    x: innerWidth,
    y: lanes[lane] - 26,
    w: 420,
    h: 52,
    lane,
    label: steps[stepIndex][0] + " — " + steps[stepIndex][1]
  });
  spawnObstacle(-240,(lane+1)%3);
  spawnObstacle(240,(lane+2)%3);
}

function update(){
  if (mode === "title"){ titleTimer++; return; }
  if (mode === "countdown"){
    countdownTick++;
    if (countdownTick % 60 === 0){
      countdown--;
      if (countdown < 0) setMode("play");
    }
    return;
  }
  if (mode !== "play") return;

  warmupFrames++;
  if (invuln>0) invuln--;
  if (slowTimer>0) slowTimer--;
  if (slowMo>0) slowMo--;

  const lanes = laneCenters();
  const ty = lanes[player.laneTarget] - player.h/2;
  player.y += (ty - player.y)*0.35;
  if (Math.abs(ty-player.y)<1){ player.y=ty; player.lane=player.laneTarget; }

  const spd = speed();
  obstacles.forEach(o=>o.x-=spd);
  bonuses.forEach(b=>b.x-=spd);
  stepTokens.forEach(s=>s.x-=spd);

  if (Math.random()<0.02) spawnObstacle();
  if (Math.random()<0.005) spawnBonus();
  if (Math.random()<0.002 && stepTokens.length===0) spawnStep();

  obstacles.forEach(o=>{
    if (o.lane!==player.lane) return;
    if (o.x<player.x+player.w-20 && o.x+o.w>player.x+20 && invuln===0){
      lives--; invuln=90; banner={text:"YOU CAUGHT: "+o.label.toUpperCase(),sub:"-1 LIFE",t:0};
      if (lives<=0) setMode("gameover");
    }
    if (o.x+o.w<player.x) obstaclesPassed++;
  });

  bonuses.forEach(b=>{
    if (b.lane!==player.lane) return;
    if (b.x<player.x+player.w){
      lives=Math.min(MAX_LIVES,lives+1);
      slowTimer=120;
      banner={text:b.label.toUpperCase(),sub:"+1 LIFE",t:0};
      b.x=-9999;
    }
  });

  stepTokens.forEach(s=>{
    if (s.lane!==player.lane) return;
    if (s.x<player.x+player.w){
      stepIndex++;
      banner={text:s.label.toUpperCase(),sub:"Nice. Keep moving.",t:0};
      s.x=-9999;
      if (stepIndex>=12) setMode("ending");
    }
  });

  obstacles.filter(o=>o.x>-600);
}

/* =======================
   DRAW
======================= */
function draw(){
  ctx.clearRect(0,0,innerWidth,innerHeight);

  if (mode==="title"){
    ctx.fillStyle="#000"; ctx.fillRect(0,0,innerWidth,innerHeight);
    ctx.fillStyle="#fff"; ctx.textAlign="center";
    ctx.font="28px 'Press Start 2P'";
    ctx.fillText("TRUDGE",innerWidth/2,innerHeight/2-100);
    ctx.fillText("THE ROAD",innerWidth/2,innerHeight/2-60);
    ctx.font="10px 'Press Start 2P'";
    ctx.fillText("avoid the traps, gather the pink clouds",innerWidth/2,innerHeight/2-10);
    ctx.fillText("go through the steps IN ORDER",innerWidth/2,innerHeight/2+20);
    ctx.fillText("PRESS SPACE / TAP",innerWidth/2,innerHeight/2+80);
    return;
  }

  if (mode==="countdown"){
    ctx.fillStyle="#000"; ctx.fillRect(0,0,innerWidth,innerHeight);
    ctx.fillStyle="#fff"; ctx.textAlign="center";
    ctx.font="14px 'Press Start 2P'";
    ctx.fillText("ROCKETED INTO THE 4TH DIMENSION IN...",innerWidth/2,innerHeight/2-120);
    ctx.font="56px 'Press Start 2P'";
    ctx.fillText(countdown>0?countdown:"GO!",innerWidth/2,innerHeight/2);
    return;
  }

  ctx.fillStyle="#111"; ctx.fillRect(0,0,innerWidth,innerHeight);

  ctx.fillStyle="#fff";
  ctx.font="14px 'Press Start 2P'";
  ctx.textAlign="center";
  ctx.fillText("TRUDGE THE ROAD",innerWidth/2,36);

  ctx.textAlign="left";
  ctx.font="10px 'Press Start 2P'";
  ctx.fillText("STEP "+(stepIndex+1)+" / 12",12,90);

  obstacles.forEach(o=>{
    ctx.strokeStyle="#f44";
    ctx.strokeRect(o.x,o.y,o.w,o.h);
    ctx.fillText(o.label.toUpperCase(),o.x+10,o.y+30);
  });

  bonuses.forEach(b=>{
    ctx.strokeStyle="#f8a";
    ctx.strokeRect(b.x,b.y,b.w,b.h);
    ctx.fillText(b.label.toUpperCase(),b.x+10,b.y+28);
  });

  stepTokens.forEach(s=>{
    ctx.strokeStyle="#fff";
    ctx.strokeRect(s.x,s.y,s.w,s.h);
    ctx.fillText(s.label.toUpperCase(),s.x+10,s.y+30);
  });

  if (runnerReady){
    runnerTick++;
    if (runnerTick%20===0) runnerFrame=(runnerFrame+1)%RUNNER_FRAMES;
    const sw=runnerImg.width/RUNNER_FRAMES;
    ctx.drawImage(runnerImg,sw*runnerFrame,0,sw,runnerImg.height,player.x,player.y,player.w,player.h);
  }

  if (banner){
    banner.t++;
    ctx.fillStyle="rgba(0,0,0,.8)";
    ctx.fillRect(innerWidth/2-320,120,640,120);
    ctx.strokeStyle="#fff";
    ctx.strokeRect(innerWidth/2-320,120,640,120);
    ctx.textAlign="center";
    ctx.font="16px 'Press Start 2P'";
    ctx.fillText(banner.text,innerWidth/2,170);
    ctx.font="12px 'Press Start 2P'";
    ctx.fillText(banner.sub,innerWidth/2,210);
    if (banner.t>140) banner=null;
  }

  if (mode==="gameover"){
    ctx.fillStyle="rgba(0,0,0,.85)";
    ctx.fillRect(0,0,innerWidth,innerHeight);
    ctx.fillStyle="#fff";
    ctx.textAlign="center";
    ctx.font="12px 'Press Start 2P'";
    ctx.fillText("GAME OVER",innerWidth/2,innerHeight/2);
    ctx.fillText("Press to try again",innerWidth/2,innerHeight/2+40);
  }

  if (mode==="ending"){
    ctx.fillStyle="rgba(0,0,0,.85)";
    ctx.fillRect(0,0,innerWidth,innerHeight);
    ctx.fillStyle="#fff";
    ctx.textAlign="center";
    ctx.font="12px 'Press Start 2P'";
    ctx.fillText("YOU GOT THROUGH THE 12 STEPS.",innerWidth/2,innerHeight/2-20);
    ctx.fillText("NOW DO IT AGAIN.",innerWidth/2,innerHeight/2+20);
  }
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

})();
</script>
</body>
</html>
