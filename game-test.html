<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trudge Brothers — SNES Intro (Option A, no sprites)</title>

  <!-- GAME FONT (Press Start 2P) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: dark; }
    html,body{ margin:0; height:100%; background:#050816; }
    canvas{
      display:block;
      margin:0 auto;
      width:min(100vw, 1080px);
      height:auto;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      background:#050816;
      touch-action: manipulation;
    }
    .hint{
      position:fixed; left:0; right:0; bottom:10px;
      text-align:center;
      font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:rgba(255,255,255,.75);
      pointer-events:none;
      text-shadow:0 2px 10px rgba(0,0,0,.6);
    }
  </style>
</head>
<body>
<canvas id="c" width="512" height="288"></canvas>
<div class="hint">Click/Tap once to enable audio • Space/Enter to advance • M = mute</div>

<script>
(() => {
  // =========================
  // Canvas
  // =========================
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha:false });
  ctx.imageSmoothingEnabled = false;

  const W = canvas.width, H = canvas.height;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;

  function fillRect(x,y,w,h,c){
    ctx.fillStyle=c;
    ctx.fillRect(x|0,y|0,w|0,h|0);
  }

  // =========================
  // Audio (SNES-ish vibe, no files)
  // =========================
  let AC=null, master=null, musicOn=true, audioEnabled=false;
  let delay=null, delayGain=null, musicTimer=null;

  function initAudio(){
    if (audioEnabled) return;
    AC = new (window.AudioContext || window.webkitAudioContext)();

    master = AC.createGain();
    master.gain.value = 0.18;

    delay = AC.createDelay(0.35);
    delay.delayTime.value = 0.14;
    delayGain = AC.createGain();
    delayGain.gain.value = 0.22;

    master.connect(AC.destination);
    master.connect(delay);
    delay.connect(delayGain);
    delayGain.connect(AC.destination);

    audioEnabled = true;
    startMusic();
  }

  function tone(freq, t, dur, type="square", gain=0.08){
    if (!audioEnabled || !musicOn) return;
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
    o.connect(g); g.connect(master);
    o.start(t); o.stop(t + dur + 0.02);
  }

  function chord(base, t, dur){
    tone(base, t, dur, "triangle", 0.030);
    tone(base*Math.pow(2, 4/12), t, dur, "triangle", 0.022);
    tone(base*Math.pow(2, 7/12), t, dur, "triangle", 0.020);
  }

  function startMusic(){
    if (!audioEnabled) return;
    if (musicTimer) clearTimeout(musicTimer);

    const bpm = 96;
    const spb = 60/bpm;

    // Slightly "Super Contra briefing room" energy: minor-ish feel
    const roots = [220, 196, 174.61, 164.81]; // A, G, F, E
    const arp = [0, 7, 10, 7, 0, 7, 12, 7]; // add minor 7-ish color
    let step = 0;

    const tick = () => {
      if (!audioEnabled || !musicOn) return;

      const t = AC.currentTime + 0.02;
      const bar = Math.floor(step / 8) % roots.length;
      const root = roots[bar];

      // pad stab
      if (step % 8 === 0) chord(root/2, t, spb*1.6);

      // arpeggio lead
      const p = arp[step % arp.length];
      const note = root * Math.pow(2, p/12);
      tone(note, t, spb*0.44, "square", 0.050);

      // little hi sparkle
      if (step % 8 === 0) tone(note*2, t+0.06, spb*0.16, "sine", 0.018);

      step++;
      musicTimer = setTimeout(tick, spb*1000);
    };
    tick();
  }

  function sfxFlashHit(){
    if (!audioEnabled || !musicOn) return;
    const t = AC.currentTime + 0.02;
    // "holy shock" + thump
    tone(110, t, 0.12, "triangle", 0.028);
    tone(440, t, 0.09, "sine", 0.028);
    tone(660, t+0.05, 0.10, "sine", 0.028);
    tone(880, t+0.11, 0.14, "sine", 0.028);
  }

  // =========================
  // Input
  // =========================
  window.addEventListener("pointerdown", () => initAudio(), {passive:true});
  window.addEventListener("click", () => initAudio(), {passive:true});
  window.addEventListener("touchstart", () => initAudio(), {passive:true});

  window.addEventListener("keydown", (e)=>{
    if (["Space","Enter","KeyM"].includes(e.code)) e.preventDefault();
    if (e.code === "KeyM") musicOn = !musicOn;
    if (e.code === "Space" || e.code === "Enter") advance();
  });

  canvas.addEventListener("pointerdown", () => { initAudio(); advance(); }, {passive:true});

  // =========================
  // Scene State
  // =========================
  const scene = {
    idx: 0,
    timer: 0,
    allowAdvance: false,

    // FX
    shake: 0,
    flash: 0,
    invert: 0,
    warp: 0,         // extra "impact"
    fadeToTitle: 0,
    title: false,

    // typing
    typing: { text:"", at:0, speed: 34, done:false },
    blink: 0,

    // world particles
    rain: [],
    dust: [],
    sparks: [],
    scanBarY: 0,

    // camera drift (adds “real game” feel)
    cam: { x:0, y:0, t:0 },

    // Bill pose
    bill: { x: 130, y: 140, pose: "sleep" },

    // title anim
    titleIn: 0,      // 0..1
    titleSlam: 0,    // shake on logo
  };

  function setMessage(lines){
    const full = (lines || []).filter(Boolean).join("\n");
    scene.typing.text = full;
    scene.typing.at = 0;
    scene.typing.done = false;
    scene.allowAdvance = false;
    scene.timer = 0;
  }

  function typedText(){
    return scene.typing.text.slice(0, Math.floor(scene.typing.at));
  }

  function updateTyping(dt){
    if (scene.typing.done) return;
    scene.typing.at += dt * scene.typing.speed;
    if (scene.typing.at >= scene.typing.text.length){
      scene.typing.at = scene.typing.text.length;
      scene.typing.done = true;
    }
    if (scene.typing.done && scene.timer > 0.30) scene.allowAdvance = true;
  }

  // =========================
  // Script beats (same story, better presentation)
  // =========================
  const beats = [
    () => { // 0
      scene.title = false;
      scene.fadeToTitle = 0;
      scene.titleIn = 0;
      scene.bill.pose = "sleep";
      setMessage(["TOWNES HOSPITAL…", "AGAIN."]);
    },
    () => { // 1
      scene.bill.pose = "sit";
      setMessage(["BILL WAKES UP STARING AT THE CEILING.", "“NOT THIS PLACE AGAIN…”"]);
    },
    () => { // 2
      scene.bill.pose = "kneel";
      setMessage(["HE WHISPERS… THEN IT COMES OUT LOUD:", "“IF THERE IS A GOD— SHOW HIMSELF TO ME!”"]);
    },
    () => { // 3 FLASH HIT
      scene.bill.pose = "kneel";
      scene.flash = 1;
      scene.invert = 1;
      scene.shake = 14;
      scene.warp = 1;
      setMessage([""]);
      spawnSparks(120, W/2, H/2, 140);
      sfxFlashHit();
    },
    () => { // 4
      scene.bill.pose = "stunned";
      setMessage(["EVERYTHING GOES QUIET.", "BILL SITS UP LIKE HE GOT UNPLUGGED AND REBOOTED."]);
    },
    () => { // 5
      scene.bill.pose = "sit";
      setMessage(["HE SAYS IT OUT LOUD— LIKE IT’S BRAND NEW:", "“WHAT IF I CAN GET THESE DRUNKS HELPING EACH OTHER?”"]);
    },
    () => { // 6 fade to title
      scene.bill.pose = "sit";
      scene.fadeToTitle = 0;
      setMessage([""]);
    }
  ];

  function advance(){
    // complete typing on first press
    if (!scene.typing.done && scene.typing.text.length){
      scene.typing.at = scene.typing.text.length;
      scene.typing.done = true;
      scene.allowAdvance = true;
      return;
    }
    // lock during flash beat
    if (scene.idx === 3) return;
    if (!scene.allowAdvance && scene.idx !== 6) return;

    scene.idx++;
    if (scene.idx >= beats.length){
      scene.idx = beats.length - 1;
      scene.title = true;
      return;
    }
    beats[scene.idx]();
  }

  // =========================
  // Particles / ambience
  // =========================
  function seedParticles(){
    // rain in window
    scene.rain = Array.from({length: 110}, () => ({
      x: 330 + Math.random()*140,
      y: 36 + Math.random()*90,
      v: 130 + Math.random()*220,
      l: 8 + Math.random()*16
    }));
    // dust motes in light cone
    scene.dust = Array.from({length: 55}, () => ({
      x: 250 + Math.random()*250,
      y: 80 + Math.random()*150,
      vx: -6 + Math.random()*12,
      vy: -10 + Math.random()*20,
      s: 1 + Math.random()*2,
      a: 0.08 + Math.random()*0.18
    }));
  }

  function spawnSparks(n, x, y, speed=160){
    for (let i=0;i<n;i++){
      const a = Math.random()*Math.PI*2;
      const sp = (speed*0.35) + Math.random()*speed;
      scene.sparks.push({
        x, y,
        vx: Math.cos(a)*sp,
        vy: Math.sin(a)*sp,
        life: 0.35 + Math.random()*0.45
      });
    }
  }

  function updateParticles(dt){
    for (const r of scene.rain){
      r.y += r.v * dt;
      r.x -= 24 * dt;
      if (r.y > 130){
        r.y = 36 - Math.random()*18;
        r.x = 330 + Math.random()*140;
      }
    }
    for (const d of scene.dust){
      d.x += d.vx * dt;
      d.y += d.vy * dt;
      if (d.x < 240) d.x = 505;
      if (d.x > 510) d.x = 250;
      if (d.y < 70) d.y = 230;
      if (d.y > 240) d.y = 80;
    }
    for (let i=scene.sparks.length-1;i>=0;i--){
      const s = scene.sparks[i];
      s.life -= dt;
      s.x += s.vx * dt;
      s.y += s.vy * dt;
      s.vx *= (1 - dt*3.2);
      s.vy *= (1 - dt*3.2);
      if (s.life <= 0) scene.sparks.splice(i,1);
    }
  }

  // =========================
  // SNES-ish drawing utilities
  // =========================
  function setFont(px){
    ctx.font = `${px}px "Press Start 2P", monospace`;
  }

  function drawTextShadow(text, x, y, px, color="rgba(255,255,255,0.95)", shadow="rgba(0,0,0,0.75)"){
    setFont(px);
    ctx.fillStyle = shadow;
    ctx.fillText(text, x+2, y+2);
    ctx.fillStyle = color;
    ctx.fillText(text, x, y);
  }

  function rgbSplitText(text, x, y, px, strength=1){
    setFont(px);
    ctx.globalAlpha = 0.80;
    ctx.fillStyle = "rgba(255,70,70,1)"; ctx.fillText(text, x-1*strength, y);
    ctx.fillStyle = "rgba(70,255,190,1)"; ctx.fillText(text, x+1*strength, y);
    ctx.fillStyle = "rgba(90,160,255,1)"; ctx.fillText(text, x, y-1*strength);
    ctx.globalAlpha = 1;
  }

  // =========================
  // Background: Hospital (SNES “Super Contra-ish” mood)
  // =========================
  function drawHospital(now){
    // Base: deep blue-gray
    fillRect(0,0,W,H,"#060916");

    // Industrial wall paneling (gives that SNES action-game vibe)
    for (let y=0; y<170; y+=26){
      const a = 0.08 + (y/170)*0.06;
      fillRect(0, y, W, 12, `rgba(255,255,255,${a})`);
      fillRect(0, y+12, W, 2, "rgba(0,0,0,0.25)");
    }

    // Overhead pipes + vents (simple geometry, but reads "SNES")
    fillRect(0, 22, W, 6, "rgba(0,0,0,0.35)");
    fillRect(0, 28, W, 2, "rgba(255,255,255,0.06)");
    for (let i=0;i<6;i++){
      const x = 26 + i*82;
      fillRect(x, 36, 56, 14, "rgba(0,0,0,0.25)");
      fillRect(x+4, 40, 48, 6, "rgba(255,255,255,0.06)");
      fillRect(x+6, 41, 8, 4, "rgba(255,255,255,0.03)");
      fillRect(x+18, 41, 8, 4, "rgba(255,255,255,0.03)");
      fillRect(x+30, 41, 8, 4, "rgba(255,255,255,0.03)");
    }

    // Floor: perspective + subtle motion (Mode 7 cheat)
    fillRect(0, 175, W, H-175, "rgba(0,0,0,0.30)");
    for (let y=175; y<H; y++){
      const t = (y-175)/(H-175);
      const w = lerp(W*0.25, W*1.10, t);
      const x = (W - w)/2;
      const row = (y + ((now/42)|0)) % 12;
      if (row === 0){
        fillRect(x, y, w, 1, `rgba(255,255,255,${0.06 + t*0.12})`);
      }
      // grime lines
      if (row === 6){
        fillRect(x, y, w, 1, `rgba(0,0,0,${0.10 + t*0.20})`);
      }
    }

    // Window
    fillRect(326, 40, 152, 104, "rgba(0,0,0,0.45)");
    fillRect(338, 52, 128, 80, "rgba(18,24,60,0.98)");

    // Rain
    ctx.fillStyle = "rgba(210,230,255,0.22)";
    for (const r of scene.rain){
      ctx.fillRect(r.x|0, r.y|0, 1, r.l|0);
    }

    // Window frame highlights
    ctx.strokeStyle = "rgba(255,255,255,0.28)";
    ctx.lineWidth = 1;
    ctx.strokeRect(337.5,51.5,129,81);
    ctx.strokeRect(401.5,52.5,1,80);
    ctx.strokeRect(338.5,91.5,128,1);

    // Window light cone + dust
    const g = ctx.createRadialGradient(420, 92, 18, 310, 130, 220);
    g.addColorStop(0, "rgba(150,190,255,0.22)");
    g.addColorStop(1, "rgba(150,190,255,0)");
    ctx.fillStyle = g;
    ctx.fillRect(200, 50, 312, 200);

    for (const d of scene.dust){
      ctx.globalAlpha = d.a;
      fillRect(d.x, d.y, d.s, d.s, "rgba(255,255,255,1)");
    }
    ctx.globalAlpha = 1;

    // Bed + props (more layered/shaded)
    fillRect(70, 148, 260, 84, "rgba(0,0,0,0.38)");      // deep shadow
    fillRect(82, 142, 240, 82, "rgba(70,100,175,0.34)"); // bed frame
    fillRect(90, 150, 224, 66, "rgba(255,255,255,0.06)");// sheet shine
    fillRect(106, 154, 64, 24, "rgba(250,250,255,0.16)");// pillow
    fillRect(110, 158, 56, 16, "rgba(255,255,255,0.08)");

    // IV stand silhouette (adds “hospital” instantly)
    fillRect(54, 108, 3, 80, "rgba(0,0,0,0.45)");
    fillRect(46, 108, 20, 3, "rgba(0,0,0,0.45)");
    fillRect(50, 92, 12, 16, "rgba(0,0,0,0.35)");

    // Bedside table + monitor
    fillRect(330, 168, 44, 42, "rgba(120,90,60,0.22)");
    fillRect(338, 140, 34, 20, "rgba(0,0,0,0.62)");
    fillRect(342, 144, 26, 12, "rgba(20,255,130,0.06)");

    // Subtle vignette base
    const vg = ctx.createRadialGradient(W/2, H/2, 60, W/2, H/2, 290);
    vg.addColorStop(0, "rgba(0,0,0,0)");
    vg.addColorStop(1, "rgba(0,0,0,0.22)");
    ctx.fillStyle = vg;
    ctx.fillRect(0,0,W,H);
  }

  // =========================
  // Bill sprite (Option A): pixel-map stamp (SNES-ish)
  // =========================
  function drawPixelSprite(map, x, y, px=3, palette={}){
    for (let row=0; row<map.length; row++){
      const line = map[row];
      for (let col=0; col<line.length; col++){
        const ch = line[col];
        if (ch === " ") continue;
        const c = palette[ch];
        if (!c) continue;
        ctx.fillStyle = c;
        ctx.fillRect((x + col*px)|0, (y + row*px)|0, px, px);
      }
    }
  }

  function drawBill(){
    // Legend:
    // K outline, S suit mid, s suit shadow, H suit highlight
    // F face mid, f face shadow, N hair
    // W shirt, T tie, . sparkle
    const pal = {
      "K":"rgba(0,0,0,0.78)",
      "S":"rgba(34,36,54,0.95)",
      "s":"rgba(18,20,34,0.95)",
      "H":"rgba(85,90,135,0.55)",
      "W":"rgba(235,238,255,0.35)",
      "T":"rgba(150,55,65,0.55)",
      "F":"rgba(255,219,185,0.92)",
      "f":"rgba(210,160,130,0.70)",
      "N":"rgba(22,20,22,0.90)",
      ".":"rgba(255,255,255,0.14)",
    };

    // “alive” idle motion
    const bob = Math.sin(performance.now()*0.004) * 1.4;
    const pose = scene.bill.pose;

    const sit = [
"            KKKKK           ",
"          KNNNNNNK          ",
"         KNNNNNNNNK         ",
"        KNNNFFfFNNNK        ",
"        KNNFF  FFNNK        ",
"        KNNF K  FNNK        ",
"         KFF  fFFK          ",
"          KFFFFFK           ",
"          KSSWTTK           ",
"         KSSWWTTTK          ",
"        KSSSWHHSSSK         ",
"        KSSsSHHsSSK         ",
"        KSSsSSSSsSK         ",
"         KSSSSSSSK          ",
"          KSSSSSK           ",
"        KKKSSSSKKK          ",
"       KSSSSSSSSSSK         ",
"      KSSsSSSSSSsSSK        ",
"      KSSSSK  KSSSSK        ",
"      KSSSK    KSSSK        ",
"       KKK      KKK         ",
    ];

    const kneel = [
"            KKKKK           ",
"          KNNNNNNK          ",
"         KNNNNNNNNK         ",
"        KNNNFFfFNNNK        ",
"        KNNFF  FFNNK        ",
"        KNNF K  FNNK        ",
"         KFF  fFFK          ",
"          KFFFFFK           ",
"          KSSWTTK           ",
"        KSSSWWTTTK          ",
"       KSSSSWHHSSSK         ",
"      KSSsSHHsSSsSK         ",
"      KSSsSSSSSSsSK         ",
"        KSSSSSSSK           ",
"        KSSSSSSSK           ",
"      KKKSSSSSSKKK          ",
"     KSSSSSSSSSSSSK         ",
"     KSSsSSK KSSsSSK        ",
"      KSSK    KSSK          ",
"      KKK      KKK          ",
"                             ",
    ];

    const stunned = [
"            KKKKK           ",
"          KNNNNNNK          ",
"         KNNNNNNNNK         ",
"        KNNNFFfFNNNK        ",
"        KNNFF  FFNNK        ",
"        KNNF K  FNNK        ",
"         KFF  fFFK     .    ",
"          KFFFFFK    .      ",
"          KSSWTTK           ",
"         KSSWWTTTK          ",
"        KSSSWHHSSSK         ",
"        KSSsSHHsSSK         ",
"        KSSsSSSSsSK         ",
"         KSSSSSSSK          ",
"          KSSSSSK           ",
"        KKKSSSSKKK          ",
"       KSSSSSSSSSSK         ",
"       KSSsSSSSsSSK         ",
"        KSSK  KSSK          ",
"         KKK  KKK           ",
"                             ",
    ];

    const sleep = [
"                             ",
"                             ",
"         KKKKKKKKKKK         ",
"       KKSSSSSSSSSSKK        ",
"     KKSSSSSSSSSSSSSSKK      ",
"    KSSSSSSSSSSSSSSSSSSK     ",
"    KSSSSSSSSSSSSSSSSSSK     ",
"     KSSSSSSSSSSSSSSSSK      ",
"      KSSSSSSSSSSSSSSK       ",
"       KSSSSSSSSSSSSK        ",
"        KSSSSSSSSSSK         ",
"         KSSSSSSSSK          ",
"   KKKKKKKSSSSSSSSKKKKKKK    ",
"  KNNNNNNKFFfF  KNNNNNNNK    ",
"  KNNNNNNKFF    KNNNNNNNK    ",
"   KNNNNNKF K   KNNNNNNK     ",
"     KKKK KFFFFFK KKKK       ",
"           KKKK              ",
"                             ",
"                             ",
    ];

    let map = sit;
    if (pose === "kneel") map = kneel;
    if (pose === "stunned") map = stunned;
    if (pose === "sleep") map = sleep;

    const px = 3;
    const drawX = (scene.bill.x)|0;
    const drawY = ((scene.bill.y + bob) |0);

    // shadow
    ctx.globalAlpha = 0.28;
    ctx.fillStyle = "#000";
    ctx.fillRect(drawX + 18, drawY + map.length*px - 6, 44, 6);
    ctx.globalAlpha = 1;

    drawPixelSprite(map, drawX, drawY, px, pal);
  }

  // =========================
  // Dialogue UI (SNES)
  // =========================
  function drawDialogueBox(text){
    if (!text) return;
    const boxX=14, boxY=H-90, boxW=W-28, boxH=76;

    // shadow
    fillRect(boxX+2, boxY+2, boxW, boxH, "rgba(0,0,0,0.35)");

    // outer + inner
    fillRect(boxX, boxY, boxW, boxH, "rgba(6,8,14,0.86)");
    fillRect(boxX+4, boxY+4, boxW-8, boxH-8, "rgba(20,26,44,0.68)");

    // border
    ctx.strokeStyle = "rgba(255,255,255,0.35)";
    ctx.lineWidth = 1;
    ctx.strokeRect(boxX+0.5, boxY+0.5, boxW-1, boxH-1);
    ctx.strokeStyle = "rgba(0,0,0,0.55)";
    ctx.strokeRect(boxX+4.5, boxY+4.5, boxW-9, boxH-9);

    // text
    const lines = text.split("\n").slice(0,3);
    for (let i=0;i<lines.length;i++){
      drawTextShadow(lines[i], boxX+16, boxY+30 + i*18, 10, "rgba(255,255,255,0.92)");
    }

    // prompt
    if (scene.typing.done){
      const a = 0.60 + 0.40*Math.sin(scene.blink);
      ctx.globalAlpha = a;
      drawTextShadow("▶", boxX+boxW-28, boxY+boxH-18, 12, "rgba(255,255,255,0.92)");
      ctx.globalAlpha = 1;
    }
  }

  // =========================
  // Title Screen (cooler SNES logo + RGB split)
  // =========================
  function drawTitle(now){
    // background
    fillRect(0,0,W,H,"#060616");
    for (let i=0;i<10;i++){
      fillRect(0, i*28, W, 12, `rgba(255,170,90,${0.02 + i*0.008})`);
    }

    // subtle moving fog bands (cheap “SNES cinematic”)
    for (let i=0;i<6;i++){
      const y = 130 + i*18 + Math.sin(now*0.001 + i)*4;
      fillRect(0, y, W, 6, "rgba(255,255,255,0.03)");
    }

    // "church basement doors" silhouette + glow
    fillRect(182, 116, 148, 122, "rgba(0,0,0,0.35)");
    fillRect(196, 130, 58, 96, "rgba(0,0,0,0.55)");
    fillRect(258, 130, 58, 96, "rgba(0,0,0,0.55)");
    fillRect(255, 132, 2, 92, "rgba(255,255,255,0.14)");

    const g = ctx.createRadialGradient(W/2, 230, 20, W/2, 230, 210);
    g.addColorStop(0, "rgba(255,220,160,0.20)");
    g.addColorStop(1, "rgba(255,220,160,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,150,W,138);

    // Title animation: slam in from above with overshoot
    scene.titleIn = clamp(scene.titleIn + 0.020, 0, 1);
    const easeOut = 1 - Math.pow(1 - scene.titleIn, 3);
    const yBase = lerp(-30, 90, easeOut);
    const overshoot = Math.sin(scene.titleIn*Math.PI) * 6;

    // Mega logo: “TRUDGE BROTHERS” with RGB split + shadow for SNES energy
    const tx = 46;
    const ty = (yBase + overshoot) |0;

    // big dark drop shadow
    ctx.globalAlpha = 0.75;
    setFont(18);
    ctx.fillStyle = "rgba(0,0,0,0.90)";
    ctx.fillText("TRUDGE BROTHERS", tx+4, ty+10);
    ctx.globalAlpha = 1;

    // RGB split main title
    rgbSplitText("TRUDGE BROTHERS", tx, ty+8, 18, 2);

    // crisp white top layer
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.fillText("TRUDGE BROTHERS", tx, ty+8);

    // subtitle
    drawTextShadow("START TO SURRENDER", 92, 130, 10, "rgba(255,255,255,0.86)");

    // PRESS START blink
    const a = 0.55 + 0.45*Math.sin(now*0.008);
    ctx.globalAlpha = a;
    drawTextShadow("PRESS START", 162, 254, 10, "rgba(255,255,255,0.92)");
    ctx.globalAlpha = 1;
  }

  // =========================
  // Post FX (CRT polish, no heavy pixel ops)
  // =========================
  function ditherOverlay(alpha=0.06){
    ctx.globalAlpha = alpha;
    ctx.fillStyle = "#000";
    for (let y=0;y<H;y+=2){
      for (let x=(y%4===0?0:2); x<W; x+=4){
        ctx.fillRect(x,y,1,1);
      }
    }
    ctx.globalAlpha = 1;
  }

  function postFX(now){
    // scanlines
    ctx.globalAlpha = 0.09;
    ctx.fillStyle = "#000";
    for (let y=0; y<H; y+=2) ctx.fillRect(0, y, W, 1);
    ctx.globalAlpha = 1;

    // vignette
    const vg = ctx.createRadialGradient(W/2, H/2, 70, W/2, H/2, 290);
    vg.addColorStop(0, "rgba(0,0,0,0)");
    vg.addColorStop(1, "rgba(0,0,0,0.36)");
    ctx.fillStyle = vg;
    ctx.fillRect(0,0,W,H);

    // micro grain
    ctx.globalAlpha = 0.08;
    for (let i=0;i<55;i++){
      const x = (Math.random()*W)|0;
      const y = (Math.random()*H)|0;
      ctx.fillStyle = Math.random()>0.5 ? "rgba(255,255,255,1)" : "rgba(0,0,0,1)";
      ctx.fillRect(x,y,1,1);
    }
    ctx.globalAlpha = 1;

    // moving bright scan bar (subtle “capture” vibe)
    scene.scanBarY = (scene.scanBarY + 40*0.016) % H;
    const barY = ((now/12)|0) % H;
    ctx.globalAlpha = 0.05;
    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.fillRect(0, barY, W, 2);
    ctx.globalAlpha = 1;

    // dither (SNES grit)
    ditherOverlay(0.05);
  }

  // Flash / impact overlays
  function applyFlashImpact(now){
    // warp is faked by stronger vignette + rgb split overlay during impact
    if (scene.warp > 0.001){
      ctx.globalAlpha = 0.10 * scene.warp;
      fillRect(0,0,W,H,"rgba(120,160,255,1)");
      ctx.globalAlpha = 1;
    }

    // strobe flash (two hits)
    if (scene.idx === 3){
      const t = scene.timer;
      let strobe = 0;
      if (t < 0.07) strobe = 1;
      else if (t < 0.12) strobe = 0.18;
      else if (t < 0.18) strobe = 0.92;
      else strobe = scene.flash;

      ctx.globalAlpha = strobe;
      fillRect(0,0,W,H,"#fff");
      ctx.globalAlpha = 1;

      const burst = ctx.createRadialGradient(W/2, H/2, 20, W/2, H/2, 240);
      burst.addColorStop(0, `rgba(255,255,255,${0.55*strobe})`);
      burst.addColorStop(1, "rgba(255,255,255,0)");
      ctx.fillStyle = burst;
      ctx.fillRect(0,0,W,H);
    } else if (scene.flash > 0.001){
      ctx.globalAlpha = scene.flash;
      fillRect(0,0,W,H,"#fff");
      ctx.globalAlpha = 1;
    }
  }

  function drawSparks(){
    for (const s of scene.sparks){
      const a = clamp(s.life / 0.8, 0, 1);
      ctx.globalAlpha = a;
      fillRect(s.x, s.y, 2, 2, "rgba(255,255,255,0.95)");
      if (Math.random() > 0.6) fillRect(s.x+2, s.y, 1, 1, "rgba(180,220,255,0.65)");
    }
    ctx.globalAlpha = 1;
  }

  // =========================
  // Main loop
  // =========================
  let last = performance.now();

  function frame(now){
    const dt = Math.min(0.05, (now-last)/1000);
    last = now;

    scene.timer += dt;
    scene.blink += dt*8;

    // ambient camera drift (subtle)
    scene.cam.t += dt;
    scene.cam.x = Math.sin(scene.cam.t*0.6)*0.8;
    scene.cam.y = Math.sin(scene.cam.t*0.45)*0.6;

    updateParticles(dt);
    updateTyping(dt);

    // beat behavior
    if (scene.idx === 3){
      scene.flash = clamp(scene.flash - dt*2.7, 0, 1);
      scene.invert = clamp(scene.invert - dt*1.8, 0, 1);
      scene.shake = clamp(scene.shake - dt*24, 0, 16);
      scene.warp  = clamp(scene.warp  - dt*2.4, 0, 1);
      if (scene.timer > 0.95){
        scene.idx++;
        beats[scene.idx]();
      }
    } else {
      if (scene.typing.done && scene.timer > 0.35 && scene.idx !== 6) scene.allowAdvance = true;
    }

    if (scene.idx === 6){
      scene.fadeToTitle = clamp(scene.fadeToTitle + dt*0.9, 0, 1);
      if (scene.fadeToTitle > 0.55) scene.title = true;
    }

    // =========================
    // Draw
    // =========================
    ctx.save();

    // camera + shake
    const sx = scene.cam.x + (Math.random()*2-1)*scene.shake;
    const sy = scene.cam.y + (Math.random()*2-1)*scene.shake;
    ctx.translate(sx|0, sy|0);

    if (!scene.title){
      drawHospital(now);
      drawBill();
      drawSparks();

      const t = typedText();
      if (t && scene.idx !== 3) drawDialogueBox(t);

      // monitor pulse
      if (scene.idx <= 2){
        const pulse = 0.5 + 0.5*Math.sin(now*0.006);
        ctx.globalAlpha = 0.10 + 0.18*pulse;
        fillRect(346, 148, 18, 7, "rgba(20,255,130,1)");
        ctx.globalAlpha = 1;
      }
    } else {
      drawTitle(now);
    }

    ctx.restore();

    // global effects
    if (!scene.title){
      applyFlashImpact(now);

      // fade to title
      if (scene.idx === 6){
        ctx.globalAlpha = scene.fadeToTitle;
        fillRect(0,0,W,H,"#000");
        ctx.globalAlpha = 1;
        if (scene.fadeToTitle > 0.75) drawTitle(now);
      }
    }

    // console polish always
    postFX(now);

    requestAnimationFrame(frame);
  }

  // =========================
  // Start
  // =========================
  function start(){
    seedParticles();
    beats[0]();
    requestAnimationFrame(frame);
    console.log("Trudge Brothers SNES Intro loaded. Click/tap for audio. Space/Enter advances. M toggles mute.");
  }
  start();

})();
</script>
</body>
</html>
